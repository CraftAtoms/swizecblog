<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecwp/component---src-components-post-js.a8953a73f94ec29b14b1.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.a8953a73f94ec29b14b1.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js"/><link as="script" rel="preload" href="/swizecwp/0-ce760dfe358fb4e73f84.js"/><link as="script" rel="preload" href="/swizecwp/app-affbd460d24d53f1fc4a.js"/><link as="script" rel="preload" href="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js"/><link rel="preload" href="/swizecwp/static/d/616/path---post-livecoding-recap-new-more-versatile-react-pattern-163-dce-pKXL71rxcHFh6joX8DJW2ntFs.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecwp/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Thoughts/">Thoughts</a></ul></div><h1>Livecoding Recap: A new more versatile React pattern</h1><div><p><em>This is a Livecoding Recap â€“ an almost-weekly post about interesting things discovered while livecoding. Usually shorter than 500 words. Often with pictures. Livecoding happens almost <strong>every Sunday at 2pm PDT</strong> on multiple channels. You should subscribe to <a href="https://www.youtube.com/user/TheSwizec">my YouTube channel</a> to catch me live.</em></p>
<p><iframe width="580" height="326" src="https://www.youtube.com/embed/OnLho6re1aI?feature=oembed" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></p>
<p>I&#8217;m working on a React &amp; D3 library that I&#8217;ve been thinking about for two years. My goal is to build <a href="https://github.com/Swizec/simple-react-d3">simple-react-d3</a>, a React and D3 library that never gets in your way.</p>
<p>Most libraries give you composable and reusable charting components that are easy to use and quick to get started with. Theyâ€™re great for simple charts.</p>
<p>But more often than not, the more custom you want your dataviz to be, the more control you need. You begin to fight your library.</p>
<p><a href="https://vx-demo.now.sh/">VX</a> comes closest to the ideal get-out-of-your-way library, and even VX when I recommended it to a friend it took all of 10 minutes for him to hit the wall. <em>&#8220;Wtf how do I do this? The library is fighting me&#8221;</em></p>
<p>ðŸ˜•</p>
<p>The best way to get started was to generalize the <code>D3Blackbox</code> pattern I developed for <a href="https://swizec.com/reactd3js">React+D3</a>. It&#8217;s the easiest and quickest way to render a random piece of D3 code in your React project.</p>
<p>Here&#8217;s an example</p>
<p><iframe src="https://codesandbox.io/embed/5v21r0wo4x?module=%2Fsrc%2FAxis.js" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></p>
<p>Take some D3 code, wrap it in a function, pass it to a HOC (higher order component), and you&#8217;re done. The HOC renders an anchor element, and your render function uses D3 to take over and manipulate the DOM.</p>
<p>This approach doesn&#8217;t give you all the benefits of React, and it doesn&#8217;t scale very well. It&#8217;s meant for simple components, quick hack jobs, or when you have a lot of existing D3 code you want to use. It is the easiest and quickest way to <a href="https://swizec.com/blog/translate-random-d3-example-react/swizec/7765">translate any random D3 example to React</a>.</p>
<p>Turning that into a library was pretty easy ðŸ‘‡</p>
<pre><code>$ nwb new react-component simple-react-d3
&lt;copy pasta&gt;
</code></pre>
<p>Boom. Library.</p>
<p>But what if you&#8217;re the kind of person who doesn&#8217;t like HOCs? Maybe you prefer render props or function-as-children?</p>
<img src="https://media.giphy.com/media/oDOnRIDjxlCzC/giphy.gif" />
<h2>A React component that supports <em>all</em> reuse patterns</h2>
<p><em>&#8220;Can we make this HOC work as not a HOC too? What if it supported it all popular React patterns for reuse&#8221;</em></p>
<p>I came up with this</p>
<blockquote class="twitter-tweet" data-width="550" data-dnt="true">
<p lang="en" dir="ltr">On a scale of 1 to 10, how terrible is this <a href="https://twitter.com/hashtag/react?src=hash&amp;ref_src=twsrc%5Etfw">#react</a> pattern? <a href="https://twitter.com/dan_abramov?ref_src=twsrc%5Etfw">@dan_abramov</a> how much would this mess with stuff from 16.3? <a href="https://t.co/xhsogX6G3J">pic.twitter.com/xhsogX6G3J</a></p>
<p>&mdash; Swizec (@Swizec) <a href="https://twitter.com/Swizec/status/978078833076142080?ref_src=twsrc%5Etfw">March 26, 2018</a></p></blockquote>
<p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>It&#8217;s a function, <code>SVGBlackbox</code>, that takes a function as argument and acts like a HOC. Pass in a func, get a component back. Just like the <code>D3Blackbox</code> example above.</p>
<p>You can also use it directly as <code>&lt;SVGBlackbox /&gt;</code>. If you do that, you can either pass a <code>render</code> prop, or a function-as-children. Both get a reference to the anchor element as their sole argument.</p>
<p>Now you can use the blackbox approach any way you like.</p>
<pre lang="javascript">
const Axis = SVGBlackbox(function() {
    const scale = d3
        .scaleLinear()
        .domain([0, 10])
        .range([0, 200]);
    const axis = d3.axisBottom(scale);

    d3.select(this.refs.anchor).call(axis);
});

class Demo extends Component {
    render() {
        return (
            <div>
                <h1>simple-react-d3 demo</h1>
                <svg width="300" height="200">
                    <Axis x={10} y={10} />
                    <SVGBlackbox x={10} y={50}>
                        {anchor => {
                            const scale = d3
                                .scaleLinear()
                                .domain([0, 10])
                                .range([0, 200]);
                            const axis = d3.axisBottom(scale);

                            d3.select(anchor).call(axis);
                        }}
                    </SVGBlackbox>
                </svg>
            </div>
        );
    }
}
</pre>
<p>That renders two axes. One above the other.</p>
<img class="alignnone size-full wp-image-8300" src="https://swizec.com/blog/wp-content/uploads/2018/03/demo-screenshot.png" width="862" height="528" srcset="https://swizec.com/blog/wp-content/uploads/2018/03/demo-screenshot.png 862w, https://swizec.com/blog/wp-content/uploads/2018/03/demo-screenshot-300x184.png 300w, https://swizec.com/blog/wp-content/uploads/2018/03/demo-screenshot-768x470.png 768w" sizes="(max-width: 862px) 100vw, 862px" />
<p>Neat.</p>
<p>Unfortunately, the internet told me this is a terrible pattern, and I should feel bad. The <code>window.requestAnimationFrame</code> part can lead to all sorts of problems and likely clashes with the future we&#8217;re getting in React 16.3.</p>
<p>However, Sophie Alpert had some good suggestions ðŸ‘‡</p>
<blockquote class="twitter-tweet" data-width="550" data-dnt="true">
<p lang="en" dir="ltr">You need the rAF call to be triggered in componentDidMount (maybe without the rAF). Otherwise it might be called before the node even exists (or while it is in the middle of an update).</p>
<p>&mdash; Sophie Alpert (@sophiebits) <a href="https://twitter.com/sophiebits/status/978096124824137728?ref_src=twsrc%5Etfw">March 26, 2018</a></p></blockquote>
<p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<blockquote class="twitter-tweet" data-width="550" data-dnt="true">
<p lang="en" dir="ltr">Make it a class? You can also return a child component that is a class. Itâ€™s also possible to do this logic in a ref callback but thatâ€™s a little obtuse.</p>
<p>&mdash; Sophie Alpert (@sophiebits) <a href="https://twitter.com/sophiebits/status/978123160947122180?ref_src=twsrc%5Etfw">March 26, 2018</a></p></blockquote>
<p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>The idea of shoving render prop stuff into the <code>ref</code> callback smells like black magic. It&#8217;s so crazy that it might just work.</p>
<h2>The ultimate reusable component</h2>
<p><iframe width="580" height="326" src="https://www.youtube.com/embed/EWVT1Cp8F4o?feature=oembed" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></p>
<p>Another livecoding session later, we did it: The ultimate reusable component. You can use it as a HOC, with render-props, or function-as-children.</p>
<p>Less than 2 minutes to grab a random D3 example from the internet and render it in a React app. Still blackbox, but works really well.</p>
<p><a href="https://youtu.be/EWVT1Cp8F4o?t=574">Starts at about 9:30</a></p>
<p><a href="https://youtu.be/EWVT1Cp8F4o?t=863">Wrapped and embedded at 14:23</a></p>
<p>It took 5 minutes because we had to update code from D3v4 to D3v5 and add some prop passing to <code>SVGBlackbox</code> to make it easier to use.</p>
<img class="alignnone size-full wp-image-8301" src="https://swizec.com/blog/wp-content/uploads/2018/03/svgblackbox-example.gif" width="1280" height="720" />
<p>You can see <a href="https://github.com/Swizec/simple-react-d3/blob/master/src/SVGBlackbox.js">full SVGBlackbox code on GitHub</a>. Here&#8217;s how the interesting part works:</p>
<div id="attachment_8299" style="width: 1338px" class="wp-caption alignnone"><img class="alignnone size-full wp-image-8299" src="https://swizec.com/blog/wp-content/uploads/2018/03/finished-svgblackbox.png" alt="SVGBlackbox" width="1328" height="1174" srcset="https://swizec.com/blog/wp-content/uploads/2018/03/finished-svgblackbox.png 1328w, https://swizec.com/blog/wp-content/uploads/2018/03/finished-svgblackbox-300x265.png 300w, https://swizec.com/blog/wp-content/uploads/2018/03/finished-svgblackbox-768x679.png 768w, https://swizec.com/blog/wp-content/uploads/2018/03/finished-svgblackbox-1024x905.png 1024w" sizes="(max-width: 1328px) 100vw, 1328px" /><p class="wp-caption-text">SVGBlackbox</p></div>
<p>When used as a HOC, it takes your argument as the render function and passes it into the usual D3Blackbox HOC. Wires up invocation as required and hands control over to you.</p>
<p>When used as a component, the argument is a <code>props</code> object. Take out <code>children</code> and <code>render</code>, store the rest as <code>props</code>. Take <code>x</code> and <code>y</code> from that.</p>
<p>Then return a <code>&lt;g&gt;</code> element moved into <code>(x, y)</code> position and given all the other props. This can be handy.</p>
<p>Now the tricky part: A <code>ref</code> callback that invokes your render function. That&#8217;s right, you can hand over control of the anchor element in the <code>ref</code> callback.</p>
<p>This works, but trips up on <a href="https://reactjs.org/docs/refs-and-the-dom.html">React&#8217;s caveat about ref callbacks</a> sometimes.</p>
<blockquote><p>
If the ref callback is defined as an inline function, it will get called twice during updates, first with null and then again with the DOM element. This is because a new instance of the function is created with each render, so React needs to clear the old ref and set up the new one.
</p></blockquote>
<p>Hence the callback is wrapped in a conditional to check that <code>anchor</code> is defined.</p>
<p>Still feels a little dirty, but much better than the <code>requestAnimationFrame</code> approach. Shouldn&#8217;t mess with async stuff in React 16.3 either, I think.</p>
<h2>Next step?</h2>
<p>Something similar for the full feature integration where D3 calculates your props and React renders your dataviz. You can see the first part of that towards the end of the 2nd video above.</p>
<p>It&#8217;s all coming together ðŸ™‚</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-livecoding-recap-new-more-versatile-react-pattern-163","path":"/post/livecoding-recap-new-more-versatile-react-pattern/"};window.dataPath="616/path---post-livecoding-recap-new-more-versatile-react-pattern-163-dce-pKXL71rxcHFh6joX8DJW2ntFs";/*]]>*/</script><script src="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js" async=""></script><script src="/swizecwp/app-affbd460d24d53f1fc4a.js" async=""></script><script src="/swizecwp/0-ce760dfe358fb4e73f84.js" async=""></script><script src="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js" async=""></script></body></html>