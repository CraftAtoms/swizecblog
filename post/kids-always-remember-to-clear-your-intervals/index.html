<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js"/><link as="script" rel="preload" href="/swizecblog/0-7538a10af02717828d76.js"/><link as="script" rel="preload" href="/swizecblog/app-e5d3c6935dd41a7392ed.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-fb9019140f39a903448b.js"/><link rel="preload" href="/swizecblog/static/d/447/path---post-kids-always-remember-to-clear-your-intervals-ac-7-128-NlB8kEL9WFT0Pw2ZcFwTe2jHQ.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/blog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Kids, always remember to clear your intervals</h1><div><p>Making fake demo graphs is always fun. Here you are, making a graph without data, generating random datapoints, trying to make it as realistic as possible.</p>
<p>Two days ago I was failing at the same.</p>
<p>It sounds simple, right? To produce a random graph, you generate random data. Something like this:</p>
<pre lang="javascript">var data = _.range(250).map(function () {
    return Math.round(Math.random()*100);
});</pre>
<p>And your graph will look like this:</p>
<div style="width: 514px" class="wp-caption alignnone"><img title="Completely random graph" alt="Completely random graph" src="https://draftin.com:443/images/23704?token=Iq6NEVfvvsGZpb_zPNwEnmnpkMCd1ENp-FvfwFL_GSuUS4IabHTwiE8tdMpidIfu5bhYk2ttjCcIVWOTwghchvM" width="504" height="379" /><p class="wp-caption-text">Completely random graph</p></div>
<p>Well, that doesn&#8217;t look realistic at all. Crazy spikes, deep valleys &#8230; if a real-world system behaved like this you would be very concerned for its wellbeing. This won&#8217;t do for a demo.</p>
<p>And besides, you wanted a live graph anyway.</p>
<p>So you move data generation into the backend and hook it up with <a class="zem_slink" title="Socket.io" href="http://socket.io/" target="_blank" rel="homepage">socket.io</a>. Then you make a function that generates one datapoint every <code>250ms</code>.</p>
<p>Data generation looks like this:</p>
<pre lang="javascript">io.on('connection', function (socket) {
    setInterval(function () {
        socket.emit('cpu', update());
    }, 250);

    function update() {
        return Math.round(Math.random()*100);
    }
});</pre>
<p>Your graph now looks like this:</p>
<div style="width: 500px" class="wp-caption alignnone"><img title="Moving random graph" alt="Moving random graph" src="https://draftin.com:443/images/23705?token=krCQBCXcCpdv5ctFEnoKGX0-m2WQBBAicnDHr4dxeT9ErO06lPH6UANr1CVMgKvili1GGWjX8dJ7ww-Be-El2CE" width="490" height="363" /><p class="wp-caption-text">Moving random graph</p></div>
<p>Yay! It moves!</p>
<p>But still too random to look realistic. A <a class="zem_slink" title="Central processing unit" href="http://en.wikipedia.org/wiki/Central_processing_unit" target="_blank" rel="wikipedia">CPU</a> that behaves like that is in serious trouble!</p>
<p>What if instead of producing random values, we produced random changes to existing values? That could work. Remember the previous state, make a tiny random change.</p>
<p>Data generation now looks like this:</p>
<pre lang="javascript">io.on('connection', function (socket) {
    var previous = 0;

    setInterval(function () {
        previous = update(previous);
        socket.emit('cpu', previous);
    }, 250);

    function (previous) {
        previous += Math.random()*10-5;
        if (previous > 100) previous = 100;
        if (previous < 0) previous = 0;

        return Math.round(previous);
    }
});</pre>
<p>And the graph looks like this:</p>
<div style="width: 500px" class="wp-caption alignnone"><img title="Fixed random graph, 1" alt="Fixed random graph, 1" src="https://draftin.com:443/images/23706?token=asWkMAA5_yoJaECCXztyXqkSFD9CSdUui9chyuS7teWMB6i_AiEBFpvbgPa9HZPFaN1o7tYjVCexouvf1Z4JVzU" width="490" height="363" /><p class="wp-caption-text">Fixed random graph, 1</p></div>
<p>Or like this:</p>
<div style="width: 500px" class="wp-caption alignnone"><img title="Fixed random graph, 2" alt="Fixed random graph, 2" src="https://draftin.com:443/images/23707?token=chVLpfrgq7JKzRbh63ovHz8wqEscb2aNKcRSmiex5U5Ssv6c9nnn-Ox7d1bUX6W-HT1A-0SxmfJfqlSyGyYXtuU" width="490" height="363" /><p class="wp-caption-text">Fixed random graph, 2</p></div>
<p>Or even like this:</p>
<div style="width: 500px" class="wp-caption alignnone"><img title="Fixed random graph, 3" alt="Fixed random graph, 3" src="https://draftin.com:443/images/23708?token=lJboUN7lbzdif0JDQyb9EMzqLYJZKS_GRO3dYIRCAo8WCbxaTOD1-0HlJ_V2JWAmDa8A_xwemibSe4t6JrM9rbY" width="490" height="363" /><p class="wp-caption-text">Fixed random graph, 3</p></div>
<p>Wait ... what? That's even worse than before! How is this possible, the value changes on each step are <em>tiny</em>?</p>
<p>And I wrecked my brain and wrecked my brain and then wrecked my brain some more. Refreshed the page many times. Rewrote the data generating function many times. Nothing I tried worked. The graph looked more sporadic than ever.</p>
<p>Can you spot the error?</p>
<p>The clue lies in those graphs moving faster and faster with each refresh. Something fucky is going on - the uncleared setInterval.</p>
<p>You see, that backend node.js process is persistent. The 250 millisecond interval doesn't just go away when you refresh the page. Oh no, it's still there, waiting for you, stalking its prey, hunting.</p>
<p>And because socket.io does evertyhing in its power to be more reliable than not, it will reconnect old sockets because hey, you probably just have spotty wi-fi. But we also started a new <code>setInterval</code> on every <code>connection</code> event.</p>
<p>Yeah.</p>
<p>That's not a single random function acting funny, that's a whole bunch of them!</p>
<p>If we fix the backend code to look like this:</p>
<pre lang="javascript">io.on('connection', function (socket) {
    var previous = 0;

    var interval = setInterval(function () {
        previous = update(previous);
        socket.emit('cpu', previous);
    }, 250);

    function (previous) {
        previous += Math.random()*10-5;
        if (previous > 100) previous = 100;
        if (previous < 0) previous = 0;

        return Math.round(previous);
    }

    socket.on('disconnect', function () {
        clearInterval(interval);
    });
});</pre>
<p>The graph looks like this:</p>
<div style="width: 500px" class="wp-caption alignnone"><img title="Moving graph, good" alt="Moving graph, good" src="https://draftin.com:443/images/23710?token=1t0RRRBKvigZ4DbNqHvHtlFTw3TCm8kUYEhq8Tx8TEZDF2VKiNvokKxrZbR_HASdHu_Fc3Imu0Xo6Y3gxhHtkew" width="490" height="363" /><p class="wp-caption-text">Moving graph, good</p></div>
<p>And all is right in the world.</p>
<p>You're happy, your boss is happy, your graph looks like it could be real but isn't. Acting.</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-kids-always-remember-to-clear-your-intervals-ac7","path":"/post/kids-always-remember-to-clear-your-intervals/"};window.dataPath="447/path---post-kids-always-remember-to-clear-your-intervals-ac-7-128-NlB8kEL9WFT0Pw2ZcFwTe2jHQ";/*]]>*/</script><script src="/swizecblog/webpack-runtime-fb9019140f39a903448b.js" async=""></script><script src="/swizecblog/app-e5d3c6935dd41a7392ed.js" async=""></script><script src="/swizecblog/0-7538a10af02717828d76.js" async=""></script><script src="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js" async=""></script></body></html>