<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecwp/component---src-components-post-js.15d6bfea4d3b992d9691.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";-webkit-font-kerning:normal;font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.15d6bfea4d3b992d9691.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecwp/component---src-components-post-js-428e04eacc0b402938d5.js"/><link as="script" rel="preload" href="/swizecwp/0-ce760dfe358fb4e73f84.js"/><link as="script" rel="preload" href="/swizecwp/app-affbd460d24d53f1fc4a.js"/><link as="script" rel="preload" href="/swizecwp/webpack-runtime-756ce6cc3c39f3c623f9.js"/><link rel="preload" href="/swizecwp/static/d/527/path---post-structure-mobx-app-real-world-4-cf-294-GIb7w7SbMLtw7v1NWlvucacn9bA.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecwp/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Thoughts/">Thoughts</a></ul></div><h1>How to structure your MobX app for the real world</h1><div><p>This article is a spiritual successor to <a href="https://swizec.com/blog/livecoding-25-adding-mobx-vanilla-react-project/swizec/7170">Adding MobX to a vanilla React project</a>, inspired by many of <a href="https://medium.com/@mweststrate">@mwestrase&#39;s articles</a>, and comes from a few weeks of refactoring a big Backbone app into a React+MobX app. It might not be <em>the</em> way to structure a MobX app, but it&#39;s <em>a</em> way, and it&#39;s been working well for me so far.</p>
<img class="alignnone size-full wp-image-7180" src="https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1.jpg" width="3024" height="3024" srcset="https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1.jpg 3024w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-150x150.jpg 150w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-300x300.jpg 300w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-768x768.jpg 768w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-1024x1024.jpg 1024w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-125x125.jpg 125w" sizes="(max-width: 3024px) 100vw, 3024px" />
<p>Design goals for this architecture are:</p>
<ul>
<li>minimize boilerplate</li>
<li>your app is a state machine</li>
<li>flexibility to move elements</li>
</ul>
<p>We&#39;re going to minimize boilerplate by relying on React contexts and MobX&#39;s wonderful <code>inject</code> function. The combination makes your data stores available everywhere in the app without having to do any wiring and passing by props. Component needs to access the state machine? Inject the store.</p>
<p>Your designer can reshuffle the page as much as he or she wants, and all you have to do is change where components go. No rewiring of the business logic unless the business logic itself changes. For me, this was the missing piece of the puzzle with React. Using this approach, your components become truly independent, and you can do whatever you want.</p>
<p>It&#39;s so much fun that I even came to work early once! If you know me, you know how much I like long mornings for myself.</p>
<h2>This is how it&#8217;s done</h2>
<p>Contexts and inject give us flexibility and remove boilerplate. What about the state machines?</p>
<p>We&#39;re going to treat our MobX stores as the only source of truth in the app <em>and</em> we&#39;re going to put actions into them. Actions change state and can be called from anywhere. Putting them in the store reduces boilerplate, makes sure all components have access to them, and lets you see the whole state machine in a single file.</p>
<p>This also makes your app easier to test. If your state machine works, everything works. This is because:</p>
<ul>
<li>MobX in strict mode guarantees state only changes in actions</li>
<li>React guarantees the DOM is a pure expression of state</li>
</ul>
<p>Yes, MobX works with mutable state and change observers and all that fun stuff. This sounds icky, if you&#39;ve been listening to the past few years of functional programming propaganda about immutable state.</p>
<p>But you know what&#39;s cool? You get all the benefits of that anyway. MobX wraps your state changes in getters and setters, but it <em>could</em> potentially back those with an immutable data structure and actions <em>could</em> build a changelog for a time traveling debugger.</p>
<p>That might be a fun project. I could use a time traveling debugger for MobX ?</p>
<p>Models are another piece of the puzzle.</p>
<p>Models represent specific objects within your overall data structure. MobX stores are for state your whole app cares about; models are for state that only a specific instance of a specific React component cares about.</p>
<p>That sounds like it should go in component state, right? But that’s a bad idea because it makes your stuff harder to test and breaks the state machine ideal.</p>
<p>Models are also a great place to put actions that talk to your backend. Save, fetch, update, that sort of stuff.</p>
<hr />
<h2>Let’s build a box of kakis</h2>
<p>You should think of this as pseudocode.</p>
<p>Let&#39;s build a box of <a href="https://en.wikipedia.org/wiki/Diospyros_kaki" title="Japanese persimmons">kakis</a>. I have one of those on my kitchen counter right now because they grow in my girlfriend&#39;s mom&#39;s backyard. Who knew? ¯&#95;(ツ)_/¯</p>
<img class="alignnone size-full wp-image-7179" src="https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1.jpg" width="3024" height="3024" srcset="https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1.jpg 3024w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-150x150.jpg 150w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-300x300.jpg 300w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-768x768.jpg 768w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1024x1024.jpg 1024w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-125x125.jpg 125w" sizes="(max-width: 3024px) 100vw, 3024px" />
<p>A box of kakis can be opened or closed. It can be sealed shut with sticky tape, and it contains kakis. Its state machine looks like this:</p>
<img class="alignnone size-full wp-image-7180" src="https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1.jpg" width="3024" height="3024" srcset="https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1.jpg 3024w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-150x150.jpg 150w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-300x300.jpg 300w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-768x768.jpg 768w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-1024x1024.jpg 1024w, https://swizec.com/blog/wp-content/uploads/2016/11/Slack-for-iOS-Upload-1-1-125x125.jpg 125w" sizes="(max-width: 3024px) 100vw, 3024px" />
<p>Once the box is open, you can add or remove as many kakis as you want. You can close the box from any <code>N kaki</code> state, but you have to open it to add or remove kakis. You can seal it only when it&#39;s closed and open it only when it&#39;s unsealed.</p>
<h3>Box, the model</h3>
<p>As a MobX store or model, your box looks like this:</p>
<pre lang="javascript">
// src/models/Box.js

import { observable, computed, action, extendObservable } from 'mobx';

export class Box {
    @observable sealed = true;
    @observable closed = true;
    @observable kakis = [];
 
    constructor(store, initialState) {
        this.store = store;
        extendObservable(this, initialState);
    }
 
    @computed get canSeal() {
        return this.closed;
    }
 
    @computed get canOpen() {
        return !this.sealed;
    }
 
    @computed get canManipulatekakis() {
        return !this.closed;
    }
 
    @action addkaki() {
        this.kakis.push(new kaki());
    }
 
    @action takekaki() {
        this.kakis.pop();
    }
 
    @action open() {
        if (this.canOpen) {
            this.opened = true;
        }
    }
 
    @action close() {
        this.closed = true;
    }
 
    @action seal() {
        if (this.canSeal) {
            this.sealed = true;
        }
    }
 
    @action unseal() {
        this.sealed = false;
    }
}
</pre>
<p><code>@observable</code> is a MobX decorator that makes properties observable so MobX can do its thing. <code>extendObservable</code> is a convenient way to set a bunch of observable values on an object. <code>@computed</code> marks some properties as deriving purely from state so MobX can memoize them, and <code>@action</code> marks methods as actions.</p>
<p>Look at the state machine picture. Observables and computeds put together are the circles (states), and actions are the arrows (transitions between states).</p>
<h3>Main app component</h3>
<p>So much work for a box, right? But look what happens when we put this in a React component:</p>
<pre lang="javascript">
// src/components/App.js

import { Provider } from 'mobx-react';

import { Box } from './models/Box';

// would normally go in src/stores/...
class MainStore {
    @observable box = null;
 
    @action getBoxFromMail() {
        this.box = new Box({sealed: true,
                                                closed: true,
                                                kakis: [new kaki(), new kaki()]});
    }
}

class App extends Component {
    mainStore = new MainStore();
 
    render() {
        const mainStore = this.mainStore;
     
        return (
            <Provider mainStore={mainStore}>
                <div>
                    <Button onClick={mainStore.getBoxFromMail.bind(mainStore)}>
                        Get Mail
                    </Button>
                 
                    <Box />
                </div>
            </Provider>
        );
    }
}
</pre>
<p>We set up a new <code>MainStore</code>, which holds the main state for our app. Stuff that everyone needs like have you picked up the box of kakis from the mail yet, is your counter black, is your refrigerator running. That sort of thing.</p>
<p>Inside the render function, we use <code>Provider</code> to add <code>mainStore</code> to a React context. Any component inside <code>Provider</code> can get access to <code>mainStore</code> if it needs to.</p>
<p>The nice thing about bundling actions with your stores and models is that you can use them in <code>onClick</code> handlers. Which means most of your components can be stateless functional components.</p>
<h3>Box, the React component</h3>
<p>Let me show you.</p>
<pre lang="javascript">
// src/components/Box.js

import { inject, observer } from 'mobx-react';

const SealedOrOpened = observer(({ box }) => (
    if (box.sealed) {
        return 'Sealed and Closed';
    }else if (!box.sealed && !box.opened) {
        return 'You should open the box';
    }else{
        return 'Take some kakis!';
    }
));

// this helper normally goes somewhere else
const If = ({ cond, children }) => cond ? children : null;

const Box = inject('mainStore')(observer(({ mainStore }) => {
    const box = mainStore.box;
 
    return (
    <div>
        <SealedOrOpened box={box} />
        <If cond={box.canOpen}>
            <Button onClick={box.open.bind(box)}>Open box</Button>
        </If>
     
        <If cond={box.opened}>
            <ul>
                {box.kakis.map(kaki => <kaki />)}
            </ul>
            <Button onClick={box.takekaki.bind(box)}>
                Take a kaki
            </Button>
        </If>
    </div>
    );
));
</pre>
<p>That&#39;s the <code>Box</code> component in spirit. It renders some text telling you what to do with the box and gives you a button that opens it. Yes, I know there should be a button to take off the sticky tape, too.</p>
<p>Once you open the box, a list of kakis appears and a button to take them out one by one.</p>
<p>Notice that <code>Box</code> is a functional stateless component. You can do that because all the state and all the actions are in the <code>Box</code> MobX model. There’s no need to build local click handlers.</p>
<p>You might also notice that we <code>inject(&#39;mainStore&#39;)</code>&#39;d into the Box component. That lets us move the component to anywhere within the DOM tree inside <code>Provider</code> and it will continue to work. No changes necessary.</p>
<h3>❤️ all around</h3>
<p>Your designer will love the flexibility, and your PM will fart rainbows at how fast you are.</p>
<p>Oh, and that <code>observer</code> thingy? That ensures your components re-render when state changes.</p>
<p>Next week, I&#39;m going to write about persisting those changes to a backend of some sort. I’m still working on how to make that part effortless and clean 🙂</p>
<p>Maybe I should make a <em>Building Webapps With React and MobX</em> book ? <a href="mailto:hi@swizec.com">Tell me</a> if you&#39;re interested.</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-structure-mobx-app-real-world-4cf","path":"/post/structure-mobx-app-real-world/"};window.dataPath="527/path---post-structure-mobx-app-real-world-4-cf-294-GIb7w7SbMLtw7v1NWlvucacn9bA";/*]]>*/</script><script src="/swizecwp/webpack-runtime-756ce6cc3c39f3c623f9.js" async=""></script><script src="/swizecwp/app-affbd460d24d53f1fc4a.js" async=""></script><script src="/swizecwp/0-ce760dfe358fb4e73f84.js" async=""></script><script src="/swizecwp/component---src-components-post-js-428e04eacc0b402938d5.js" async=""></script></body></html>