<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js"/><link as="script" rel="preload" href="/swizecblog/0-f215691c134019ee6fa5.js"/><link as="script" rel="preload" href="/swizecblog/app-49ff0b4ea28eff25fc3b.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-b34af8fd410bb07c9828.js"/><link rel="preload" href="/swizecblog/static/d/291/path---post-my-new-favourite-javascript-trick-707-8cd-Zx8RmgRtOxRwIK3QdCTT1GYRogg.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>My new favourite Javascript trick</h1><div><p>Using returns and <a class="zem_slink" title="Callback (computer programming)" href="http://en.wikipedia.org/wiki/Callback_%28computer_programming%29" target="_blank" rel="wikipedia">callbacks</a> in the same function.</p>
<p>Sounds like crazy talk I know, but hear me out, I have good reason. I think.</p>
<p>Let&#8217;s say you want to make several <a class="zem_slink" title="Transmission Control Protocol" href="http://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank" rel="wikipedia">TCP</a> servers in a node.js application. Have to listen on multiple ports or whatever. Using a factory function is your best bet to avoiding code repetition, right?</p>
<p>You end up with something like this:</p>
<pre lang="javascript">var server = function (port, callback) {
    var server = net.createServer(function (connection) {});

    server.on("connection", function (socket) {
        socket.on("data", // data stuff);

        socket.on("error", function () {
            console.log("error?", arguments);
            socket.destroy();
        });
        socket.on("close", // cleanup stuff);
    });

    server.on("listening", callback);
    server.listen(port);
};</pre>
<p>Simple. Call a function, give it a port, get notified when server is ready to listen. Never be able to touch the server again.</p>
<p>Wait, that&#8217;s not good. What if you want to reference the server later? To close it, for instance.</p>
<p>That&#8217;s where using returns alongside callbacks comes in.</p>
<p>Just adding a <code>return server</code> at the bottom of that function lets us do something like this:</p>
<pre lang="javascript">var make_servers = function (callback) {
    this.servers = {};

    async.each([5000, 5001, 5002],
               _.bind(function (port, callback) {
                    this.servers[port] = server(port, callback);
               }, this),
               function (err) {
                    callback();
               });

    return this;
}</pre>
<p>I sneakily added the async and underscore libraries because they make life easier.</p>
<p><code>make_servers</code> will generate three servers listening on ports <code>5000</code> to <code>5002</code>. The async library helped us ensure the main callback is only called once all the servers are ready to listen, and using <code>_.bind</code> let us bind server generation to the current scope.</p>
<p>When this function is done it returns its scope, which now includes references to all the servers, and it will tell your code to keep going when all the servers are ready.</p>
<p>You&#8217;d use it something like this:</p>
<pre lang="javascript">var stuff = make_servers(function () { // all servers listening });

// stuff.servers can access all servers</pre>
<p>If you bind all the callbacks inside <code>server</code> to current scope you can even keep track of connections. You&#8217;d end up with something like this:</p>
<pre lang="javascript">var server = function (port) {
    var server = net.createServer(function (connection) {});

    server.on("connection", _.bind(function (socket) {
        socket.id = shortid.generate();
        this.connections[port][socket.id] = socket;

        socket.on("data", // data stuff);

        socket.on("error", function () {
            console.log("error?", arguments);
            socket.destroy();
        });
        socket.on("close", _.bind(function () {
            delete this.connections[port][socket.id];
        }, this));
    }, this));

    return function (callback) {
        server.on("listening", callback);
        server.listen(port);        
        return server;
    };
};</pre>
<p>Not much has changed. More things were bound to <code>this</code> and the <a class="zem_slink" title="Return statement" href="http://en.wikipedia.org/wiki/Return_statement" target="_blank" rel="wikipedia">return value</a> became a function because I feel <a class="zem_slink" title="Partial application" href="http://en.wikipedia.org/wiki/Partial_application" target="_blank" rel="wikipedia">partial application</a> makes this code cleaner.</p>
<p>You&#8217;d call the <code>server</code> factory like this now: <code>this.servers[port] = server(port)(callback)</code>. The main benefit of this approach is that we can generate servers in a loop and activate them at a later time.</p>
<p>We&#8217;ve essentially decoupled server generation and server startup. Might come in handy.</p>
<p>The <code>stuff</code> object from before is now going to have a <code>stuff.connections</code> as well, which references all currently open connections to each port. Neat!</p>
<p>Another trick I sneaked into these examples is <a class="zem_slink" title="JavaScript" href="http://en.wikipedia.org/wiki/JavaScript" target="_blank" rel="wikipedia">Javascript</a>&#8216;s powerful <a class="zem_slink" title="Scope (computer science)" href="http://en.wikipedia.org/wiki/Scope_%28computer_science%29" target="_blank" rel="wikipedia">dynamic scoping</a>. Getting semi-random functions to run in the same scope like that can really clean up your code.</p>
<p>At the expense of being almost too clever sometimes. Use at your own peril.</p>
<p>What do you think, is there a cleaner way to implement something like this?</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-my-new-favourite-javascript-trick-707","path":"/post/my-new-favourite-javascript-trick/"};window.dataPath="291/path---post-my-new-favourite-javascript-trick-707-8cd-Zx8RmgRtOxRwIK3QdCTT1GYRogg";/*]]>*/</script><script src="/swizecblog/webpack-runtime-b34af8fd410bb07c9828.js" async=""></script><script src="/swizecblog/app-49ff0b4ea28eff25fc3b.js" async=""></script><script src="/swizecblog/0-f215691c134019ee6fa5.js" async=""></script><script src="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js" async=""></script></body></html>