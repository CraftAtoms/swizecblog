<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecwp/component---src-components-post-js.a8953a73f94ec29b14b1.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.a8953a73f94ec29b14b1.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js"/><link as="script" rel="preload" href="/swizecwp/0-ce760dfe358fb4e73f84.js"/><link as="script" rel="preload" href="/swizecwp/app-affbd460d24d53f1fc4a.js"/><link as="script" rel="preload" href="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js"/><link rel="preload" href="/swizecwp/static/d/327/path---post-slack-lied-to-me-ff-9-1ae-BrH4G2hLpUMSCvvX7DuFeqyfsOo.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecwp/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Thoughts/">Thoughts</a></ul></div><h1>Slack lied to me</h1><div><p>I built my first Slack bot today. </p>
<p>It has one job: to report a specific type of error, and to do so while impersonating the office dog. It might get more jobs in the future, but you have to start somewhere. </p>
<p>Adding a Slack bot to your Rails app happens in three steps:</p>
<ol>
<li>Set up <a href="https://slack.com/apps/new/A0F7YS25R-bots">new custom integration</a>.</li>
<li>Add <a href="https://github.com/slack-ruby/slack-ruby-client">slack-ruby-client</a> to your setup.</li>
<li>Fiddle around until you reach the desired flexibility and feature set.</li>
</ol>
<p>When you&#8217;re done with the first step, Slack promises that your bot&#8217;s messages will have a friendly avatar and username.</p>
<figure>
<img src="http://i.imgur.com/bqiWYiL.png" alt="" /><br />
</figure>
<p>Instead, they don&#8217;t. Following the basic instructions, you get a grey bot image and default username.</p>
<figure>
<img src="http://i.imgur.com/3yaqj8b.png" alt="" /><br />
</figure>
<p>And so it begins. Outdated documentation. ?</p>
<p>Basic API spec says that you should post messages with an <code>as_user: true</code> flag, which makes the bot use its default settings from Step 1.</p>
<pre lang="ruby">

#Setup stuff, goes in a global file somewhere. config/initializers/slack.rb for instance

<p>Slack.configure do |config|</p>

<p>config.token = ENV[&#8216;SLACK_API_TOKEN&#8217;]</p>

<p>end</p>

#Instantiate client

<p>client = Slack::Web::Client.new</p>

#Send message to #general channel

<p>client.chat_postMessage(channel: &#8216;#general&#8217;, text: &#8216;Hello World&#8217;, as_user: true)</p>
</pre>
<p>That code throws an error <code>-&gt; user not in channel</code>. So you dig through the documentation and find <code>channels_join</code>. But that throws an error, too <code>-&gt; user is a bot</code>.</p>
<p>Bots can&#8217;t join channels.</p>
<p>If you remove <code>as_user: true</code>, then you can post, but you post without an avatar and without a username. Ugh.</p>
<p>The easiest workaround is to explicitly add a username and an avatar to your post call. It makes half of Step 1 redundant, but your bot messages look great, and your team gets excited.</p>
<figure>
<img src="http://i.imgur.com/xWO1Rwg.png" alt="" /><br />
</figure>
<p>If only they knew @quentin will only ever post errors.</p>
<p>Another way to get around the bots-cant-join-channels problem is to mention @quentin, then invite him to the channel. I&#8217;m sure that will never get difficult or annoying to manage. No chance at all.</p>
<p>Itâ€™s probably best to stick to the workaround.</p>
<p>Giving a voice to the office dog is fun and all, but the useful stuff begins when you look into attachments. Slack lets you add rich attachments to your messages. Anything from semantically color-coded styling to buttons for common actions.</p>
<p>I&#8217;m keeping it simple for now: report error, add contextual logs. In theory, this will help us quickly decide which errors are worth looking into and which aren&#8217;t.</p>
<p>Adding attachments looks like this for me:</p>
<pre lang="ruby">
client.chat_postMessage(
	channel: '#bot-test',
	text: "this is *bold*",
	attachments: [{
    color: 'warning',
    fallback: title,
    title: title,
    title_link: session_url,
    text: "*executed_at*\t*created_at*\t*user*\t*event*",
    ts: Time.now.to_f
}])
</pre>
<p>It creates a message like this:</p>
<figure>
<img src="http://i.imgur.com/3FZOz5A.png" alt="" /><br />
</figure>
<p>See those asterisks? Those are not supposed to be there. <a href="https://api.slack.com/docs/message-formatting">Slack&#8217;s message formatting rules</a> say that strings wrapped in asterisks should render bold anywhere they appear. Messages, attachments, everywhere, <strong>bold</strong>.</p>
<p>Instead, it works for the message itself but not for the attachment. Possible reasons range from a Slack bug, to a library bug, to something strange happening in how I call the library. I haven&#8217;t figured it out, and I&#8217;m probably going to decide it&#8217;s not worth my time.</p>
<p>But the office dog speaks now. ?</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-slack-lied-to-me-ff9","path":"/post/slack-lied-to-me/"};window.dataPath="327/path---post-slack-lied-to-me-ff-9-1ae-BrH4G2hLpUMSCvvX7DuFeqyfsOo";/*]]>*/</script><script src="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js" async=""></script><script src="/swizecwp/app-affbd460d24d53f1fc4a.js" async=""></script><script src="/swizecwp/0-ce760dfe358fb4e73f84.js" async=""></script><script src="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js" async=""></script></body></html>