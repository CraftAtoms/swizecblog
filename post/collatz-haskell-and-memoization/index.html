<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecwp/component---src-components-post-js.a8953a73f94ec29b14b1.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.a8953a73f94ec29b14b1.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js"/><link as="script" rel="preload" href="/swizecwp/0-ce760dfe358fb4e73f84.js"/><link as="script" rel="preload" href="/swizecwp/app-affbd460d24d53f1fc4a.js"/><link as="script" rel="preload" href="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js"/><link rel="preload" href="/swizecwp/static/d/632/path---post-collatz-haskell-and-memoization-bc-5-26e-uvY6A3owgdWBexUbOfShKUu0mA.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecwp/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Thoughts/">Thoughts</a></ul></div><h1>Collatz, Haskell and Memoization</h1><div><div style="width: 321px" class="wp-caption alignright"><a href="http://xkcd.com/710/"><img title="xkcd collatz conjecture" src="http://swizec.com/blog/wp-content/uploads/2012/01/collatz_conjecture3.png" alt="xkcd collatz conjecture" width="311" height="452" /></a><p class="wp-caption-text">xkcd collatz conjecture</p></div>
<p>After an awesome <a class="zem_slink" title="Longboarding" href="http://en.wikipedia.org/wiki/Longboarding" rel="wikipedia">longboarding</a> session yesterday afternoon I decided to play around with <a class="zem_slink" title="Sequence" href="http://en.wikipedia.org/wiki/Sequence" rel="wikipedia">infinite sequences</a> in <a class="zem_slink" title="Haskell (programming language)" href="http://haskell.org" rel="homepage">Haskell</a> &#8211; it&#8217;s supposed to be one of the more (most?) powerful features of Haskell &#8211; because it&#8217;s a <a class="zem_slink" title="Evaluation strategy" href="http://en.wikipedia.org/wiki/Evaluation_strategy" rel="wikipedia">lazy language</a> apparently.</p>
<p>My first impulse of creating a primes generator was nipped in the bud by a long page of <a href="http://www.haskell.org/haskellwiki/Prime_numbers" target="_blank">prime number generators in Haskell</a>. Scary, complex, mindboggling.</p>
<p><a class="zem_slink" title="Project Euler" href="http://projecteuler.net/" rel="homepage">Project Euler</a> posed a much better challenge:Â <em>Which starting number, under one million, produces the longest collatz chain?</em></p>
<p>The solution I came up with was a simple brute force generator of infinitely many collatz sequences. Then I would take the first 1,000,000 find the maximum and that&#8217;s that.</p>
<pre lang="haskell">
collatz :: Integer -> [Integer]
collatz 1 = []
collatz n
    | odd n = 3*n+1:collatz(3*n+1)
    | even n = div n 2:collatz(div n 2)

chains = [collatz x | x <- [1..]]
</pre>
<p>Didn't help.</p>
<p>So I started looking for the maximum a bit differently - take all the sequences, sort them by length and take the last one.</p>
<pre lang="haskell">longest max =
  last $ sortBy (comparing snd) $ zip [1..] $ map length $ take max chains</pre>
<p>Great! It worked! But it takes ~26 seconds!</p>
<p>Well sorting maybe isn't the best idea ever, so let's try creating a list of sequences where the list's tail only contains those sequences that are longer than the head. A sprinkle of dropWhile and it was done.</p>
<pre lang="haskell">longest' (max_i, max_l) =
  let l = head $ dropWhile (\(i,l) -> l <= max_l) $ zip [max_i..] $ map length $ chains' max_i
  in l:longest' l
</pre>
<p>~25 seconds!</p>
<p>That's odd ... even odder still is running both algorithms one after another only takes 33 seconds. Huh?</p>
<p>It would seem I'm using <a class="zem_slink" title="Memoization" href="http://en.wikipedia.org/wiki/Memoization" rel="wikipedia">memoization</a> incorrectly. I've heard it performs funny in recursive functions. The theory I formulated last night was that because haskell was lazy each execution chain was constructed to its end and the intermittent memoized values never got used until the whole function was called again.</p>
<p>Looking at the code samples this morning, though, I discovered this:</p>
<pre lang="haskell">collatz :: Integer -> [Integer]
collatz = memoize col where
  col 1 = []
  col n
    | odd n = 3*n+1:collatz(3*n+1)
    | even n = div n 2:collatz(div n 2)
</pre>
<p>As you can see, I don't call the memoized function internally. Just goes to show what a night's sleep can do to one's coding abilities. I bashed my head against this problem for four hours yesterday and I never noticed I was recursing to the wrong function!</p>
<p>Interestingly enough, fixing that makes the algorithm spaz out and die after 16 seconds. The only output I get is "Killed". Curious.</p>
<h6 class="zemanta-related-title" style="font-size: 1em;">Related articles</h6>
<ul class="zemanta-article-ul">
<li class="zemanta-article-ul-li"><a href="http://mrhonner.com/2011/11/18/graphing-the-collatz-conjecture/">Graphing the Collatz Conjecture</a> (mrhonner.com)</li>
<li class="zemanta-article-ul-li"><a href="http://existentialtype.wordpress.com/2011/04/24/the-real-point-of-laziness/">The Point of Laziness in Programing Languages</a> (existentialtype.wordpress.com)</li>
<li class="zemanta-article-ul-li"><a href="http://swizec.com/blog/learning-me-a-haskell/swizec/3272">Learning me a Haskell</a> (swizec.com)</li>
<li class="zemanta-article-ul-li"><a href="http://geeklogs.posterous.com/what-is-memoization">Memoization explained using a python implementation of fibonacci</a> (geeklogs.posterous.com)</li>
</ul>
<div class="zemanta-pixie" style="margin-top: 10px; height: 15px;"><a class="zemanta-pixie-a" title="Enhanced by Zemanta" href="http://www.zemanta.com/"><img class="zemanta-pixie-img" style="border: none; float: right;" src="http://img.zemanta.com/zemified_e.png?x-id=6f7c0838-57e3-4b8a-a0c3-3ef0dc670559" alt="Enhanced by Zemanta" /></a></div>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-collatz-haskell-and-memoization-bc5","path":"/post/collatz-haskell-and-memoization/"};window.dataPath="632/path---post-collatz-haskell-and-memoization-bc-5-26e-uvY6A3owgdWBexUbOfShKUu0mA";/*]]>*/</script><script src="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js" async=""></script><script src="/swizecwp/app-affbd460d24d53f1fc4a.js" async=""></script><script src="/swizecwp/0-ce760dfe358fb4e73f84.js" async=""></script><script src="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js" async=""></script></body></html>