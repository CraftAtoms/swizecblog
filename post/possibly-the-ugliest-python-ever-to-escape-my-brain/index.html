<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-352e8466f0cbd742adc0.js"/><link as="script" rel="preload" href="/swizecblog/0-7538a10af02717828d76.js"/><link as="script" rel="preload" href="/swizecblog/app-e5d3c6935dd41a7392ed.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-bf7869bd5fe0e771eaf7.js"/><link rel="preload" href="/swizecblog/static/d/123/path---post-possibly-the-ugliest-python-ever-to-escape-my-brain-4-cd-14c-FvnJPqcSjRAfRkjuHje1cm0iAo.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Possibly the ugliest python ever to escape my brain</h1><div><p>Lensing <a class="zem_slink" title="Data" href="http://en.wikipedia.org/wiki/Data" rel="wikipedia">data</a> from one format to another always produces the most horrible code &#8230; here&#8217;s some I wrote last night:</p>
<pre lang="python">    
    # some other code here

    def stitch(*iterables):
        return [(iterables[0][i][0], sum([l[i][1] for l in iterables]))
                for i in xrange(len(iterables[0]))]

    def one(z):
        d = dict(stitch(*[[b for b in zip(a.keys(), a.values()) if b[0] in ['count', 'step_conv_ratio', 'overall_conv_ratio']] for a in z]))

        d['overall_conv_ratio'] = d['overall_conv_ratio']/len(funnel['meta']['dates'])
        d['step_conv_ratio'] = d['step_conv_ratio']/len(funnel['meta']['dates'])
        return d

    print map(one,
              zip(*[v['steps'][:entry['counts']['p']] for v in funnel['data'].values()]))</pre>
<div style="width: 195px" class="wp-caption alignright"><a href="http://en.wikipedia.org/wiki/File:Funnel_of_the_Mauretania.jpg"><img class="zemanta-img-inserted zemanta-img-configured " title="The funnel of the Mauretania." src="http://swizec.com/blog/wp-content/uploads/2012/02/Funnel_of_the_Mauretania3.jpg" alt="The funnel of the Mauretania." width="185" height="320" /></a><p class="wp-caption-text">Also a funnel</p></div>
<p>Can you guess what all of that does? Me neither, let me try to explain.</p>
<h2>WTF!</h2>
<p>Firstly, the basic problem I&#8217;m trying to solve is fetching some funnel data from <a class="zem_slink" title="Mixpanel" href="http://www.mixpanel.com" rel="homepage">Mixpanel</a>, which returns all the data I need, but it is split into different days and I&#8217;d really like to have it all mashed together. Due to the design of funnels in their <a class="zem_slink" title="Application programming interface" href="http://en.wikipedia.org/wiki/Application_programming_interface" rel="wikipedia">API</a>, they also return too much data, which spoils what I&#8217;m looking for.</p>
<p>Their format is something like this:</p>
<pre lang="javascript">{'Signup flow': {'data': {'2010-05-24': {'analysis': {'completion': 0.064679359580052493,
                                               'starting_amount': 762,
                                               'steps': 3,
                                               'worst': 2},
                                  'steps': [{'count': 762,
                                             'goal': 'pages',
                                             'overall_conv_ratio': 1.0,
                                             'step_conv_ratio': 1.0},
                                            {'count': 69,
                                             'goal': 'View signup',
                                             'overall_conv_ratio': 0.09055118110236221,
                                             'step_conv_ratio': 0.09055118110236221},
                                            // etc.},
                   '2010-05-31': // etc.
          'meta': {'dates': ['2010-05-24', '2010-05-31']}}}</pre>
<p>What I want is something where &#8220;Signup flow&#8221; would be just a list of steps where count is a sum of all counts for that step and conversion ratios are the average between all days. Yes this discards some useful data, but it&#8217;s not too relevant for what I&#8217;m trying to analyze.</p>
<h2>Justified?</h2>
<p>Hopefully I can defend this code, explain why it&#8217;s ugly.</p>
<pre lang="python">map(one,
    zip(*[v['steps'][:entry['counts']['p']] for v in funnel['data'].values()]))</pre>
<p>This code takes the data for each day, iterates over it to take only the <em>steps</em> key, cuts its list at an appropriate length (the funnel&#8217;s got 60+ steps, I have extra data to tell me how much is actually applicable). Then zips all the steps together.</p>
<p>Now we have a list of step <a class="zem_slink" title="Tuple" href="http://en.wikipedia.org/wiki/Tuple" rel="wikipedia">tuples</a> &#8211; all the first steps, second steps and so on.</p>
<p>Then we apply the one function on each tuple:</p>
<pre lang="python">def one(z):
        d = dict(stitch(*[[b for b in zip(a.keys(), a.values()) if b[0] in ['count', 'step_conv_ratio', 'overall_conv_ratio']] for a in z]))

        d['overall_conv_ratio'] = d['overall_conv_ratio']/len(funnel['meta']['dates'])
        d['step_conv_ratio'] = d['step_conv_ratio']/len(funnel['meta']['dates'])
        return d</pre>
<p>Right, so the first thing that happens is we turn a dictionary into a list of <em>(key, value)</em> tuples, then this is filtered so only the ones we&#8217;re actually interested in remain (count and the conversion ratios).</p>
<p>These are then stitched together:</p>
<pre lang="python">def stitch(*iterables):
        return [(iterables[0][i][0], sum([l[i][1] for l in iterables]))
                for i in xrange(len(iterables[0]))]</pre>
<p>Looks pretty bad, but really just turns a list of <em>(key, value)</em> tuples into a list of <em>(key, sum of corresponding values)</em> tuples.</p>
<p>Finally, the conversion values are turned into the average by simply dividing with the number of days this funnel was tracked for.</p>
<h2>Better way?</h2>
<p>This is the cleanest and most elegant way I could come up with to solve this problem &#8211; there&#8217;s bound to be something cleaner and easier. Actually, <em>please</em> tell me there&#8217;s a better way!</p>
<p>Generally speaking, is there even a good approach to take for converting data returned from somewhere into the kind of data you need somewhere else? Or are we doomed to forever spend most of our time figuring out how to get API&#8217;s talking to one another?</p>
<h6 class="zemanta-related-title" style="font-size: 1em;">Related articles</h6>
<ul class="zemanta-article-ul">
<li class="zemanta-article-ul-li"><a href="http://usapartisan.com/2012/02/07/a-quality-assessment-of-us-jobs-reveals-the-ugliest-picture-yet/">A &#8220;Quality Assessment&#8221; Of US Jobs Reveals The Ugliest Picture Yet</a> (usapartisan.com)</li>
<li class="zemanta-article-ul-li"><a href="http://stackoverflow.com/questions/8542010/ironpython-lists-tuples-dictionaries-crash-wcf-communications">IronPython Lists, Tuples, Dictionaries crash WCF communications</a> (stackoverflow.com)</li>
<li class="zemanta-article-ul-li"><a href="http://stackoverflow.com/questions/8875195/python-entry-widget-tuple-combo">python entry widget tuple combo</a> (stackoverflow.com)</li>
<li class="zemanta-article-ul-li"><a href="http://stackoverflow.com/questions/8658995/recursively-create-tuples-from-lists">recursively create tuples from lists</a> (stackoverflow.com)</li>
<li class="zemanta-article-ul-li"><a href="http://stackoverflow.com/questions/8107254/regarding-list-of-tuples-and-file">Regarding list of tuples and file</a> (stackoverflow.com)</li>
<li class="zemanta-article-ul-li"><a href="http://socialmediacorporatesolutions.wordpress.com/2012/02/13/feeding-the-funnel-with-facebook/">Feeding The Funnel With Facebook</a> (socialmediacorporatesolutions.wordpress.com)</li>
</ul>
<div class="zemanta-pixie" style="margin-top: 10px; height: 15px;"><a class="zemanta-pixie-a" title="Enhanced by Zemanta" href="http://www.zemanta.com/"><img class="zemanta-pixie-img" style="border: none; float: right;" src="http://img.zemanta.com/zemified_e.png?x-id=2991a8b4-c6f1-4e7d-b19f-d376285fcee7" alt="Enhanced by Zemanta" /></a></div>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-possibly-the-ugliest-python-ever-to-escape-my-brain-4cd","path":"/post/possibly-the-ugliest-python-ever-to-escape-my-brain/"};window.dataPath="123/path---post-possibly-the-ugliest-python-ever-to-escape-my-brain-4-cd-14c-FvnJPqcSjRAfRkjuHje1cm0iAo";/*]]>*/</script><script src="/swizecblog/webpack-runtime-bf7869bd5fe0e771eaf7.js" async=""></script><script src="/swizecblog/app-e5d3c6935dd41a7392ed.js" async=""></script><script src="/swizecblog/0-7538a10af02717828d76.js" async=""></script><script src="/swizecblog/component---src-components-post-js-352e8466f0cbd742adc0.js" async=""></script></body></html>