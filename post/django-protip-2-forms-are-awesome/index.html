<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecwp/component---src-components-post-js.15d6bfea4d3b992d9691.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";-webkit-font-kerning:normal;font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.15d6bfea4d3b992d9691.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecwp/component---src-components-post-js-428e04eacc0b402938d5.js"/><link as="script" rel="preload" href="/swizecwp/0-ce760dfe358fb4e73f84.js"/><link as="script" rel="preload" href="/swizecwp/app-affbd460d24d53f1fc4a.js"/><link as="script" rel="preload" href="/swizecwp/webpack-runtime-756ce6cc3c39f3c623f9.js"/><link rel="preload" href="/swizecwp/static/d/987/path---post-django-protip-2-forms-are-awesome-3-cf-583-6rogmJg2jQzxOy1Gx2LkrickDPk.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecwp/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Thoughts/">Thoughts</a></ul></div><h1>Django protip #2: Forms are awesome</h1><div><div class="zemanta-img" style="margin: 1em; display: block;">
<div>
<dl class="wp-caption alignright" style="width: 170px;">
<dt class="wp-caption-dt"><a href="http://www.flickr.com/photos/50811886@N00/2686845422"><img title="Moss" src="http://swizec.com/blog/wp-content/uploads/2010/08/2686845422_d924cc453e_m.jpg" alt="Moss" width="160" height="240" /></a></dt>
<dd class="wp-caption-dd zemanta-img-attribution" style="font-size: 0.8em;">Image by <a href="http://www.flickr.com/photos/50811886@N00/2686845422">warrenski</a> via Flickr</dd>
</dl>
</div>
</div>
<p>Welcome to another installment of Swizec&#8217;s <a class="zem_slink freebase/en/django_web_framework" title="Django (web framework)" rel="homepage" href="http://www.djangoproject.com">Django</a> protip. Previously we discussed a better way to <a href="http://swizec.com/blog/django-protip-1-a-better-app-structure/swizec/1386">structure your django apps</a>, but nobody cared about that because everybody is rather silly. This time we&#8217;ll be talking about how awesome forms are and why you should be using them for pretty much everything. At the end, I&#8217;ll show you some neat <a class="zem_slink freebase/en/tips_tricks" title="Tips &amp; Tricks" rel="wikipedia" href="http://en.wikipedia.org/wiki/Tips_%26_Tricks">tips and tricks</a> I discovered during my Django Epiphany.</p>
<h3>Why forms</h3>
<p>When you look at code a lot of web developers produce (and yes, even I did it plenty of times back in the day) you will notice a lot of work goes into retrieving data from GET and POST parameters. Now despite most developers simply ignoring GET parameters as anything really special or dangerous and just handling them as if they were regular variables, because hey, what could go wrong about retrieving a page number right? At best you&#8217;ll see code having a bunch of lines sort of like this:</p>
<pre lang="php">$page = (isset($_GET['page'])) ? intval($_GET['page']) : 0;</pre>
<p>Anyone notice a security flaw? Then think of this, what happens if the page is set to -1? Sure, if errors aren&#8217;t being displayed right to the user nothing too important. But if they get shown an <a class="zem_slink freebase/en/sql" title="SQL" rel="wikipedia" href="http://en.wikipedia.org/wiki/SQL">SQL</a> error &#8230; or worse &#8230;</p>
<p>However people are usually at least a little bit more careful about POST data because they realise that hey, this is something a person filled in a <a class="zem_slink freebase/guid/9202a8c04000641f8000000000955540" title="Form (web)" rel="wikipedia" href="http://en.wikipedia.org/wiki/Form_%28web%29">web form</a> and perhaps the data should go through a series of a little bit more stringent tests before it gets chucked into the <a class="zem_slink freebase/en/database" title="Database" rel="wikipedia" href="http://en.wikipedia.org/wiki/Database">database</a>. Hell, maybe we could even tell the user where they screwed up and if the planets are in constelation, why not also make sure those required fields are actually filled out &#8230; you know, so we don&#8217;t get any weird inconsistencies in our database.</p>
<p>But still, it&#8217;s a lot of work to do all of that by hand every god damn time. If only there were something easier, more transparent and plain old automagical &#8230;</p>
<h3>Cue Django Forms</h3>
<p>In django, all of this comes automagically. There is this thing called a &#8220;form&#8221;, which basically lets you define what parameters a request needs, be it GET or POST based, what they should validate against and most importantly, what&#8217;s required and what is not.</p>
<p>If you&#8217;re into that sort of stuff you even get building the form in a html, so the users can use it, completely for free and magically with all the required &#8220;Hey bozo, you filled so and so field wrong. Fix it!&#8221;. For every field! Magic.</p>
<p>But since most of my time is spent on developing <a class="zem_slink freebase/guid/9202a8c04000641f80000000163b3ef7" title="Application programming interface" rel="wikipedia" href="http://en.wikipedia.org/wiki/Application_programming_interface">API</a>&#8216;s rather than user-facing <a class="zem_slink freebase/en/website" title="Website" rel="wikipedia" href="http://en.wikipedia.org/wiki/Website">websites</a> let me show you how to use forms effectively in that sort of environment. For the html stuff just go check out the <a href="http://docs.djangoproject.com/en/dev/topics/forms/" target="_blank">django form docs</a>.</p>
<p>The basic use of forms goes a little bit like this (hopefully your forms are in a separate file from your views, this is just an example :P)</p>
<pre lang="python">from django import forms

class ListForm(forms.Form):
    feed = forms.IntegerField(required=False)
    category = forms.IntegerField(required=False)
    since = forms.DateTimeField(required=False)
    count = forms.IntegerField(required=False)
    page = forms.IntegerField(required=False)
    include_content = forms.BooleanField(required=False)

def list(request, format='json'):
    form = ListForm(request.user, request.GET)

    if form.is_valid():
       articles = Article.objects.filter(feed__in=form.cleaned_data['feeds']
                                                  ).order_by('-time')[page*count:page*count+count]
       return HttpResponse(json.dumps({'status': 'OK',
                                        'count': len(articles),
                                        'articles': articles}))
    else:
	return HttpResponseBadRequest(json.dumps({'status': 'ERROR'}))</pre>
<p>Well something along those lines anyhow. What you can see is that I basically define a form and check that it&#8217;s valid. Once I know it&#8217;s valid I can go on using its cleaned_data without much regard for anything.</p>
<h3>Some tips&amp;tricks</h3>
<p>And now let&#8217;s get onto some tips&amp;tricks ðŸ™‚</p>
<p>First thing you&#8217;ll notice once you start using forms like you properly should is that all of your views follow this pattern: get form; validate form; do something; or do something else;</p>
<p>So I wrote up a descriptor for that, now I can be certain that when I&#8217;m in my view the form is valid and I can use the data.</p>
<pre lang="python">def form_valid(form_type, data_type):
    def inner(view_func):
        def wrapper(request, *args, **kwargs):
            form = form_type(request.__getattribute__(data_type))

            if form.is_valid():
                request.form = form
                return view_func(request, *args, **kwargs)
            else:
                return HttpResponseBadRequest(json.dumps({'status': 'ERROR'}))
        return wraps(view_func)(wrapper)
    return inner

## the usage goes like so
@form_valid(ImageForm, 'GET')
def image(request):
    blob = BlobInfo.gql("WHERE filename='%s' LIMIT 1" % request.form.cleaned_data['id'])[0]

    return HttpResponse(BlobReader(blob.key()).read(),
                        content_type=blob.content_type)</pre>
<p>Using the decorator thus makes for much much cleaner code.</p>
<p>Now let&#8217;s look at some magic done with custom clean functions inside forms ðŸ˜›</p>
<pre lang="python">## this enables us to handle <a class="zem_slink freebase/en/comma-separated_values" title="Comma-separated values" rel="wikipedia" href="http://en.wikipedia.org/wiki/Comma-separated_values">comma separated values</a> seamlessly
    def clean_feed(self):
        try:
            feed = [int(id) for id in str(self.cleaned_data['feed']).split(',')]
        except (AttributeError, ValueError, KeyError):
            feed = None
        return feed

## automagically parsing json parameters can be done too
    def clean_feeds(self):
        feeds = json.loads(self.cleaned_data['feeds'])
        if type(feeds) != list:
            raise forms.ValidationError("list of feeds expected")
        return feeds

## or how about logging in the user while we're checking the user/pass is correct
## don't manually log in users unless you know at least somewhat what you're doing, usually django handles this
    def clean(self):
        cleaned_data = self.cleaned_data

        if len(self.errors) != 0:
            return cleaned_data

        user = authenticate(username=cleaned_data['email'],
                            password=cleaned_data['password'])
        if user is None:
            del cleaned_data['email']
            del cleaned_data['password']
            raise forms.ValidationError('Bad login')
        else:
            cleaned_data['user'] = user

        return cleaned_data

## now the strangest thing, when you have to handle grabbing data by different parameters
##(like being given a set of feed ids, or a feed category id, you can do this by returning
## a QuerySet in the form's cleaned_data
def clean(self):
        cleaned_data = self.cleaned_data

        if not (cleaned_data.get('feed', None) != None or cleaned_data.get('category', None) != None):
            raise forms.ValidationError("feed or category required")

        if cleaned_data['feed'] != None:
            user_feeds = UserFeed.objects.filter(user=self.user,
                                                 id__in=cleaned_data['feed'])
        else:
            user_feeds = UserFeed.objects.filter(user=self.user,
                                                 categories__contains="'%d'" % cleaned_data['category'])

        cleaned_data['feeds'] = map(lambda f: f.id,
                                    Feed.objects.filter(id__in=map(lambda f: f.feed, user_feeds)))

        reverse_feeds = {}
        for feed in user_feeds:
            reverse_feeds[feed.feed] = feed.id
        cleaned_data['reverse_feeds'] = reverse_feeds

        return cleaned_data</pre>
<h3>Conclusion</h3>
<p>Anyhow, that&#8217;s it as far as forms are concerned. Do sound off in the comments or on twitter if I fucked up somewhere. I know geeks like to argue. Come back next week when I&#8217;ll be talking about different magical things you can do with decorators and why they are uber awesome to use in django (or well any other type of python development really)</p>
<h6 class="zemanta-related-title" style="font-size: 1em;">Related articles by Zemanta</h6>
<ul class="zemanta-article-ul">
<li class="zemanta-article-ul-li"><a href="http://swizec.com/blog/django-protip-1-a-better-app-structure/swizec/1386">Django protip #1: A better App structure</a> (swizec.com)</li>
<li class="zemanta-article-ul-li"><a href="http://swizec.com/blog/small-trick-for-seamless-base64-password-storage-in-django/swizec/1378">Small trick for seamless base64 password storage in django</a> (swizec.com)</li>
<li class="zemanta-article-ul-li"><a href="http://tidbids.posterous.com/saas-with-django-and-postgresql">Django and SaaS</a> (tidbids.posterous.com)</li>
<li class="zemanta-article-ul-li"><a href="http://almirkaric.com/2010/5/2/things-i-hate-in-django/">Things i hate in django</a> (almirkaric.com)</li>
</ul>
<div class="zemanta-pixie" style="margin-top: 10px; height: 15px;"><a class="zemanta-pixie-a" title="Enhanced by Zemanta" href="http://www.zemanta.com/"><img class="zemanta-pixie-img" style="border: none; float: right;" src="http://img.zemanta.com/zemified_e.png?x-id=c1b237d5-fb11-4a02-a61d-ebecc9071b07" alt="Enhanced by Zemanta" /></a><span class="zem-script more-related more-info pretty-attribution"><script src="http://static.zemanta.com/readside/loader.js" type="text/javascript"></script></span></div>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-django-protip-2-forms-are-awesome-3cf","path":"/post/django-protip-2-forms-are-awesome/"};window.dataPath="987/path---post-django-protip-2-forms-are-awesome-3-cf-583-6rogmJg2jQzxOy1Gx2LkrickDPk";/*]]>*/</script><script src="/swizecwp/webpack-runtime-756ce6cc3c39f3c623f9.js" async=""></script><script src="/swizecwp/app-affbd460d24d53f1fc4a.js" async=""></script><script src="/swizecwp/0-ce760dfe358fb4e73f84.js" async=""></script><script src="/swizecwp/component---src-components-post-js-428e04eacc0b402938d5.js" async=""></script></body></html>