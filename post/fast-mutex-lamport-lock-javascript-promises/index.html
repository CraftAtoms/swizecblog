<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.15d6bfea4d3b992d9691.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";-webkit-font-kerning:normal;font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.15d6bfea4d3b992d9691.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-428e04eacc0b402938d5.js"/><link as="script" rel="preload" href="/swizecblog/0-20c56a8bf68923b243f7.js"/><link as="script" rel="preload" href="/swizecblog/app-f4c654d11b4415967aef.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-559e9e27cf35c66d2ba0.js"/><link rel="preload" href="/swizecblog/static/d/379/path---post-fast-mutex-lamport-lock-javascript-promises-117-d9a-0RXRahao29pcKRa6I6cZRLFPgo.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>A Fast Mutex Lamport Lock with JavaScript Promises</h1><div><p><iframe width="853" height="480" src="https://www.youtube.com/embed/NQqDJoLqMtE" frameborder="0" allowfullscreen></iframe></p>
<p>I&#39;m trying something new. Today the video is stronger than the post. Watch it ?</p>
<p>On Tuesday, I implemented a JavaScript queue backed by local storage. It&#39;s goal in life is to ensure we don&#39;t lose events when tracking usage funnels on our app.</p>
<p>Yes, losing an event that takes 600ms to send is an edge case.</p>
<p>Yes, we still want to make sure we don&#39;t lose anything.</p>
<p>Plus, with a queue we have more flexibility to send bursts of events to our backend. Firing an XHR request every time a user clicks a button feels excessive.</p>
<p>That&#39;s why it&#39;s going in a queue, and the queue will eventually process it. At first, 1 event is 1 request, and we have a good path forward to send in batches.</p>
<p>Because we store the queue in local storage, you don&#39;t lose events even if you close your tab before something finishes saving. Hopefully you come back a second time so we get a chance to process your queue. If you don&#39;t, we can&#39;t. ?</p>
<p>Simple, right?</p>
<p>Yep. Stringify a JSON array. Save to local storage. Pull out, JSON parse, add stuff, put back in.</p>
<p>And what if the same user runs multiple tabs? What if some events that you want to track happen without user interaction? And just like that, tabs step on each other&#39;s toes, and you lose events because local storage is a shared resource.</p>
<h2>Fast mutex to the rescue!</h2>
<p>Here&#39;s how the <a href="http://www.cs.rochester.edu/research/synchronization/pseudocode/fastlock.html">Lamport lock algorithm</a> works:</p>
<img class="alignnone size-full wp-image-7531" src="https://swizec.com/blog/wp-content/uploads/2017/03/algorithm-pic.png" width="747" height="420" srcset="https://swizec.com/blog/wp-content/uploads/2017/03/algorithm-pic.png 747w, https://swizec.com/blog/wp-content/uploads/2017/03/algorithm-pic-300x169.png 300w" sizes="(max-width: 747px) 100vw, 747px" />
<p>You need 2 shared memory locations, <code>A</code> and <code>B</code>.</p>
<p>When a new thread needs the lock, it first sets <code>A</code> to its <code>id</code>. Then it checks if <code>B</code> is free. If <code>B</code> is <em>not</em> free, we retry. If <code>B</code> <em>is</em> free, we set <code>B</code> to <code>id</code>. Then we check that <code>A</code> is still equal to <code>id</code>.</p>
<p>If <code>A</code> has changed, we&#39;re potentially facing a lock contention. So we wait long enough for others to realize we&#39;re doing stuff and back off. Then we check that <code>B</code> is still <code>id</code>. If <code>B</code> is <em>not</em> equal to <code>id</code>, then we&#39;ve lost the lock and we go back to beginning. If <code>B</code> <em>is</em> equal to <code>id</code>, it means we&#39;ve won the lock and we do stuff.</p>
<p>It sounds confusing because it <em>is</em> confusing. Study the flowchart. Drawing it helped me understand how this works. And I&#39;m not sure I could <em>prove</em> that it works.</p>
<p>Here&#39;s what the Lamport lock looks like when implemented with JavaScript promises.</p>
<pre lang="javascript">
get lock() {
    return this._lock(0);
}

_lock(retries) {
    const A = `${this.name}_lock_A`,
          B = `${this.name}_lock_B`;

    const _retry = (resolve, reject) => {
        window.requestAnimationFrame(() =>
            this._lock(retries + 1).then(resolve, reject)
        );
    }

    const _free = (name) => {
        const val = this._getItem(name);
        return Number(val) === 0 || val === undefined || val === null;
    }

    this._setItem(A, this.id);

    return new Promise((resolve, reject) => {
        // retries > 10, force lock
        if (_free(B) || retries > 10) {
            this._setItem(B, this.id);

            if (this._getItem(A) === this.id) {
                // no contention, do stuff
                resolve();
                this._setItem(B, 0);
            }else{
                // possible contention
                window.requestAnimationFrame(() => {
                    if (this._getItem(B) === this.id) {
                        // won lock, do stuff
                        resolve();
                        this._setItem(B, 0);
                    }else{
                        _retry(resolve, reject);
                    }
                });
            }
        }else{
            _retry(resolve, reject);
        }
    });
}
</pre>
<p>Done with promises so it&#39;s easier to use. You&#39;d do something like this when writing to local storage:</p>
<pre lang="javascript">
this.lock.then(() => writeStuff())
</pre>
<p>That&#39;s elegant, right? I think it is.</p>
<p>But what does all that lock code <em>do</em>? Well, it implements the Lamport lock algorithm with one small addition.</p>
<p>Our threads –&nbsp;browser tabs –&nbsp;can die before releasing the lock. The user closes the tab, JavaScript error, things like that. That&#39;s why we limit retries to <code>&lt;10</code>.</p>
<p>Yes, that&#39;s an arbitrary value. No, saving to local storage should never take more than 10 requestAnimationFrames. It&#39;s a fast, synchronous operation.</p>
<p>Look at the code and the flowchart side-by-side. I made sure they&#39;re the same ?</p>
<img class="alignnone size-full wp-image-7530" src="https://swizec.com/blog/wp-content/uploads/2017/03/together-screenshot.png" width="1299" height="703" srcset="https://swizec.com/blog/wp-content/uploads/2017/03/together-screenshot.png 1299w, https://swizec.com/blog/wp-content/uploads/2017/03/together-screenshot-300x162.png 300w, https://swizec.com/blog/wp-content/uploads/2017/03/together-screenshot-768x416.png 768w, https://swizec.com/blog/wp-content/uploads/2017/03/together-screenshot-1024x554.png 1024w" sizes="(max-width: 1299px) 100vw, 1299px" />
<p>Don&#39;t believe me that it works? <a href="https://www.microsoft.com/en-us/research/publication/fast-mutual-exclusion-algorithm/?from=http://research.microsoft.com/en-us/um/people/lamport/pubs/fast-mutex.pdf">Read Lamport&#39;s original paper</a>; it includes correctness proofs.</p>
<p>Watch <a href="https://youtu.be/NQqDJoLqMtE">the video</a> to see it in action.</p>
<p>Thanks to <a href="https://medium.engineering/wait-dont-touch-that-a211832adc3a">Dan Pupius for the idea</a>.</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-fast-mutex-lamport-lock-javascript-promises-117","path":"/post/fast-mutex-lamport-lock-javascript-promises/"};window.dataPath="379/path---post-fast-mutex-lamport-lock-javascript-promises-117-d9a-0RXRahao29pcKRa6I6cZRLFPgo";/*]]>*/</script><script src="/swizecblog/webpack-runtime-559e9e27cf35c66d2ba0.js" async=""></script><script src="/swizecblog/app-f4c654d11b4415967aef.js" async=""></script><script src="/swizecblog/0-20c56a8bf68923b243f7.js" async=""></script><script src="/swizecblog/component---src-components-post-js-428e04eacc0b402938d5.js" async=""></script></body></html>