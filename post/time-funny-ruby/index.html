<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecwp/component---src-components-post-js.a8953a73f94ec29b14b1.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.a8953a73f94ec29b14b1.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js"/><link as="script" rel="preload" href="/swizecwp/0-ce760dfe358fb4e73f84.js"/><link as="script" rel="preload" href="/swizecwp/app-affbd460d24d53f1fc4a.js"/><link as="script" rel="preload" href="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js"/><link rel="preload" href="/swizecwp/static/d/570/path---post-time-funny-ruby-730-57f-aBSsFxd6P5P26SiLBbJII8rPyuQ.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecwp/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Thoughts/">Thoughts</a></ul></div><h1>Time is funny in Ruby</h1><div><p><iframe width="853" height="480" src="https://www.youtube.com/embed/2uj_2G_KaGw" frameborder="0" allowfullscreen></iframe></p>
<p>Ruby is great. Or maybe Rails is what&#39;s great… after 4 years, I still don&#39;t quite know where the line lies ?</p>
<p>One of my favorite features is this:</p>
<pre lang="ruby">
> "next sunday".to_date
 => Sun, 26 Mar 2017 
```
```ruby
> 2.2.0 :003 > "last sunday".to_date
 => Sun, 26 Mar 2017 
</pre>
<p>Wait a minute… <code>next sunday</code> and <code>last sunday</code> are the same date? O.o</p>
<p>By the way, it&#39;s Tuesday right now. Next Sunday is April 2nd, and last Sunday was March 26th.</p>
<p>Ok, that&#39;s weird. But what if we change <code>Date.now</code> to Monday? Let&#39;s try that.</p>
<pre lang="ruby">
2.2.0 :008 > Timecop.freeze("April 3rd, 2017".to_datetime) do
2.2.0 :009 >     Date.today
2.2.0 :010?>   end
 => Sun, 02 Apr 2017  
</pre>
<p>?</p>
<p><em>PS: <a href="https://github.com/travisjeffery/timecop">Timecop</a> is a Ruby library meant for testing. It lets you specify the value of &quot;now&quot;</em></p>
<p>April 2nd is not April 3rd… timezones? Gotta be timezones.</p>
<pre lang="ruby">
2.2.0 :011 > Timecop.freeze("April 3rd, 2017".to_datetime) do
2.2.0 :012 >     DateTime.now
2.2.0 :013?>   end
 => Sun, 02 Apr 2017 17:00:00 -0700
</pre>
<p>Ah. <code>to_datetime</code> without a time of day sets time to midnight in UTC. Then when you call <code>DateTime.now</code>, you get your local timezone. Completely intuitive!</p>
<pre lang="ruby">
2.2.0 :014 > Timecop.freeze("April 3rd, 2017 1pm".to_datetime) do
2.2.0 :015 >     DateTime.now
2.2.0 :016?>   end
 => Mon, 03 Apr 2017 07:00:00 -0700  
</pre>
<p>Okay, that&#39;s better. Does <code>&quot;next Sunday&quot;</code> work now?</p>
<pre lang="ruby">
2.2.0 :020 > Timecop.freeze("Mar 27, 2017 1pm".to_datetime) do
2.2.0 :021 >     "next sunday".to_datetime
2.2.0 :022?>   end
 => Sun, 26 Mar 2017 00:00:00 +0000  
</pre>
<p>Nope. Doesn&#39;t even react to current time being mocked. <em>That</em>&#39;s intuitive.</p>
<p>Turns out, if you want to find next Sunday, you have to use <code>Date.today.sunday</code>. Because… I don&#39;t know why.</p>
<pre lang="ruby">
2.2.0 :023 > Date.today.sunday
 => Sun, 02 Apr 2017 
 
2.2.0 :024 > Timecop.freeze("April 3rd, 2017 1pm".to_datetime) do
2.2.0 :025 >     Date.today.sunday
2.2.0 :026?>   end
 => Sun, 09 Apr 2017 
</pre>
<p>Excellent! That worked. Today, we get next Sunday. On Monday, we get next next Sunday. Just what you&#39;d expect!</p>
<p>Now watch this.</p>
<pre lang="ruby">
2.2.0 :027 > Timecop.freeze("April 3rd, 2017".to_datetime) do
2.2.0 :028 >     Date.today.sunday
2.2.0 :029?>   end
 => Sun, 02 Apr 2017
</pre>
<p>Timezones? Timezones.</p>
<p>Even though time freezing happens in UTC, time getting happens in your local timezone. So when they misalign, Monday becomes Sunday, and <em>obviously</em> if today is Sunday and you want to find next Sunday, that&#39;s today. D&#39;oh.</p>
<p>?</p>
<p>Oh, the fun I had figuring that one out! Almost pushed to production without realizing these quirks existed! ?</p>
<h2>But why? Let&#39;s find out.</h2>
<p>Here is the source for <code>to_datetime</code>: <a href="http://apidock.com/rails/String/to%5C_datetime">link</a></p>
<pre lang="ruby">
# File activesupport/lib/active_support/core_ext/string/conversions.rb, line 53
  def to_datetime
    ::DateTime.parse(self, false) unless blank?
  end
</pre>
<p>Great, we know that <code>to_datetime</code> is a Rails method, not a Ruby method. It’s part of the <code>ActiveSupport</code> gem, which looks like a bag of all utility methods you might find useful in a Rails project.</p>
<p>Neat.</p>
<p>The <code>to_datetime</code> method looks like magic. My understanding is that it&#39;s part of the string class, which makes it defined on every string. Once called, it passes itself – <code>self</code> –&nbsp;into <code>Datetime.parse</code>.</p>
<p>So what is <code>DateTime</code>?</p>
<p>It looks like a part of core extensions. Its source is split into <a href="https://github.com/rails/rails/tree/92703a9ea5d8b96f30e0b706b801c9185ef14f0e/activesupport/lib/active_support/core_ext/date_time">five files</a>, so I have no idea what&#39;s what. Curiously, there is also <code>DateAndTime</code>. They do not seem to do the same things. ?</p>
<p>And I&#39;m having trouble finding the <code>parse</code> method. It shows up in <a href="https://github.com/rails/rails/search?l=Ruby&amp;q=parse&amp;type=&amp;utf8=%E2%9C%93">107 rails source files</a> and none of them is <code>DateTime</code>. How strange… maybe it&#39;s in Ruby after all?</p>
<p>It is!</p>
<p><a href="https://github.com/ruby/ruby/blob/d8bf1785316c55e3befac9db0981180bd1432b49/ext/date/date_core.c">Deep inside Ruby&#39;s C source code</a>, the <code>DateTime</code> class is defined. You&#39;d think Ruby used the <a href="https://en.wikipedia.org/wiki/Bootstrapping%5C_(compilers)">bootstrapping compiler</a> approach and was written in Ruby, but nope. It looks like it&#39;s done in C. Who knew… ¯\<em>(ツ)</em>/¯</p>
<p>To the best of my understanding, this is the code that becomes <code>.parse</code> once Ruby is compiled and looks like Ruby.</p>
<pre lang="C">
static VALUE
datetime_s_parse(int argc, VALUE *argv, VALUE klass)
{
    VALUE str, comp, sg;

    rb_scan_args(argc, argv, "03", &str, &comp, &sg);

    switch (argc) {
      case 0:
    str = rb_str_new2("-4712-01-01T00:00:00+00:00");
      case 1:
    comp = Qtrue;
      case 2:
    sg = INT2FIX(DEFAULT_SG);
    }

    {
    VALUE argv2[2], hash;

    argv2[0] = str;
    argv2[1] = comp;
    hash = date_s__parse(2, argv2, klass);
    return dt_new_by_frags(klass, hash, sg);
    }
}
</pre>
<p>I don&#39;t know what all this code does, but it seems to eventually use good old <code>strptime</code> and guesses which format to use. That means it doesn&#39;t really care if we say <code>this Sunday</code> or <code>next Sunday</code>. It sees only <code>Sunday</code>.</p>
<p>And when <code>strptime</code> sees <code>Sunday</code>, it returns the current&#39;s week&#39;s Sunday, which in Ruby land is the 0th day of the week. I don&#39;t know why Ruby thinks Sunday is the first day of the week, but it seems like large parts of the world think that way.</p>
<p><em>shrug</em></p>
<blockquote><p>
According to the Hebrew calendars and traditional Christian calendars, Sunday is the first day of the week. However, according to the International Organization for Standardization ISO 8601, Sunday is the seventh and last day of the week.
</p></blockquote>
<blockquote><p>
<a href="https://en.wikipedia.org/wiki/Sunday">Wikipedia</a>
</p></blockquote>
<h2>So?</h2>
<p>That was fun. I don&#39;t think we learned anything <em>useful</em>. But it&#39;s good to know that even though Ruby and Rails can <em>handle</em> fancy relative time strings, they actually ignore the most informative part.</p>
<p>Oops. ??‍♂️</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-time-funny-ruby-730","path":"/post/time-funny-ruby/"};window.dataPath="570/path---post-time-funny-ruby-730-57f-aBSsFxd6P5P26SiLBbJII8rPyuQ";/*]]>*/</script><script src="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js" async=""></script><script src="/swizecwp/app-affbd460d24d53f1fc4a.js" async=""></script><script src="/swizecwp/0-ce760dfe358fb4e73f84.js" async=""></script><script src="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js" async=""></script></body></html>