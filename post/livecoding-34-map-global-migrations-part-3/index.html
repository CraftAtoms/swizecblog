<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js"/><link as="script" rel="preload" href="/swizecblog/0-7538a10af02717828d76.js"/><link as="script" rel="preload" href="/swizecblog/app-e5d3c6935dd41a7392ed.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-fb9019140f39a903448b.js"/><link rel="preload" href="/swizecblog/static/d/691/path---post-livecoding-34-map-global-migrations-part-3-54-f-ae4-nMeJXdnY5RH2Qxw1w6EVGCv20aU.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/blog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Livecoding #34: A Map of Global Migrations, Part 3</h1><div><p><em>This is a Livecoding Recap – an almost-weekly post about interesting things discovered while livecoding ?. Always under 500 words and with pictures. You can follow my channel, <a href="https://liveedu.tv/swizec">here</a>. New content almost <strong>every Sunday at 2pm PDT</strong>. There’s live chat, come say hai ?</em></p>
<p><iframe src="https://www.liveedu.tv/swizec/videos/8v3yz/embed" width="560" height="315" frameborder="0" allowfullscreen="true" scrolling="no"></iframe></p>
<p>This Sunday, we built a zoomable pannable map with React and D3. We also added animation to our migration curves. Now people can see what they mean.</p>
<div id="attachment_7454" style="width: 1301px" class="wp-caption alignnone"><a href="https://swizec.github.io/migrations-map/"><img class="wp-image-7454 size-full" src="http://swizec.com/blog/wp-content/uploads/2017/02/uk-migrations.gif" alt="Click on the map to see a live example" width="1291" height="564" /></a><p class="wp-caption-text">Click on the map to see a live example</p></div>
<p>See? It zooms and it pans and the circles follow their curves. Just like the color, the amount of circles on each line signifies migration intensity. ?</p>
<p>Here&#39;s how it works ?</p>
<h2>Animate SVG element to follow a curve</h2>
<p>Moving an element along a line is one of those things you think you can figure out on your own but you can&#39;t. Then you see how it&#39;s done and you think, <em>&quot;I&#39;m dumb&quot;</em>.</p>
<p>But you&#39;re not dumb. It&#39;s totally un-obvious.</p>
<p>We used Bostock&#39;s <a href="https://bl.ocks.org/mbostock/1705868">Point-Along-Line Interpolation</a> example as our model. It creates a custom tween that we apply to each circle as an <code>attrTween</code> transition.</p>
<pre lang="javascript">
function translateAlong(path) {
    var l = path.getTotalLength();
    return function(d, i, a) {
        return function(t) {
            var p = path.getPointAtLength(t * l);
            return "translate(" + p.x + "," + p.y + ")";
        };
    };
}
</pre>
<p>That&#39;s the custom tween. I&#39;d love to explain how it works, but… well, we have a <code>getPointAtLength</code> function that SVG gives us by default on every <code>&lt;path&gt;</code> element. We use it to generate <code>translate(x, y)</code> strings that we feed into the <code>transform</code> attribute of a <code>&lt;circle&gt;</code> element. That part is obvious.</p>
<p>The part I don&#39;t get is the 3-deep function nesting for currying. The top function returns a tween, I assume. It&#39;s a function that takes <code>d, i, a</code> as arguments and never uses them. Instead, it returns a time-parametrized function that returns a <code>translate(x, y)</code> string for each <code>t</code>.</p>
<p>We know from D3 conventions that <code>t</code> runs in the <code>[0, 1]</code> interval, so we can assume the tween gives a <em>&quot;point at t percent of full length of path&quot;</em> coordinates.</p>
<p>Great.</p>
<p>We apply it in our <code>MigrationLine</code> component like this:</p>
<pre lang="javascript">
// inside MigrationLine
    _transform(circle, delay) {
        const { start } = this.props,
              [ x1, y1 ] = start;

        d3.select(circle)
          .attr("transform", `translate(${x1}, ${y1})`)
          .transition()
          .delay(delay)
          .duration(this.duration)
          .attrTween("transform", translateAlong(this.refs.path))
          .on("end", () => {
              if (this.state.keepAnimating) {
                  this._transform(circle, 0);
              }
          });
    }
    
    componentDidMount() {
        const { Ncircles } = this.props;

        this.setState({
            keepAnimating: true
        });

        const delayDither = this.duration*Math.random(),
              spread = this.duration/Ncircles;

        d3.range(delayDither, this.duration+delayDither, spread)
          .forEach((delay, i) =>
              this._transform(this.refs[`circles-${i}`], delay)
          );
    }
</pre>
<p>We call <code>_transform</code> on every circle in our component. Each gets a different <code>delay</code> so that we get a roughly uniform distribution of circles on the line. Without this, they come in bursts, and it looks weird.</p>
<p><code>delayDither</code> ensures the circles for each line start with a random offset, which also helps fight the burstiness. Here&#39;s what the map looks like without <code>delayDither</code> and with a constant delay between circles regardless how many there are.</p>
<img class="alignnone size-full wp-image-7452" src="https://swizec.com/blog/wp-content/uploads/2017/02/bursty-map-1.gif" width="1291" height="564" />
<p>See? No good.</p>
<p>You can see the <a href="https://github.com/Swizec/migrations-map/blob/de8800aecca4484f8c5827a82c8a746127264143/src/MigrationLine.js">full MigrationLine code on Github</a>.</p>
<h2>Zoom and pan a map</h2>
<p>This part was both harder and easier than I thought.</p>
<p>You see, D3 comes with something called <a href="https://github.com/d3/d3-zoom">d3.zoom</a>. It does zooming <em>and</em> panning.</p>
<p>Cool, right? Should be easy to implement. And it is… if you don&#39;t fall down a rabbit hole.</p>
<p>In the old days, the standard approach was to <code>.call()</code> zoom on an <code>&lt;svg&gt;</code> element, listen for <code>zoom</code> events, and adjust your scales. Zoom callback would tell you how to change zoominess and where to move, and you&#39;d adjust your scales and re-render the visualization.</p>
<p>We tried that approach with hilarious results:</p>
<img class="alignnone size-full wp-image-7451" src="https://swizec.com/blog/wp-content/uploads/2017/02/drag-1.gif" width="921" height="516" />
<p>First, it was moving in the wrong direction, then it was jumping around. Changing the geo projection to achieve zoom and pan was <em>not</em> the answer. Something was amiss.</p>
<p>Turns out in D3v4, the zoom callback gets info to build an SVG transform. A <code>translate()</code> followed by a <code>scale()</code>.</p>
<p>Apply those on the visualization and you get working zooming and panning! Of anything 😀</p>
<pre lang="javascript">
// in SVG rendering component
    onZoom() {
        this.setState({
            transform: d3.event.transform
        });
    }

    get transform() {
        if (this.state.transform) {
            const { x, y, k } = this.state.transform;
            return `translate(${x}, ${y}) scale(${k})`;
        }else{
            return null;
        }
    }
    // ...
    render() {
        return (
            <svg width={width} height={height} ref="svg">
                <g transform={this.transform}>
                // ...
    }
</pre>
<p>Get <code>d3.event.transform</code>, save it in <code>state</code> or a data store of some sort, re-render, use it on a <code>&lt;g&gt;</code> element that wraps everything.</p>
<p>Voila, zooming and panning. ?</p>
<div id="attachment_7454" style="width: 1301px" class="wp-caption alignnone"><a href="https://swizec.github.io/migrations-map/"><img class="wp-image-7454 size-full" src="http://swizec.com/blog/wp-content/uploads/2017/02/uk-migrations.gif" alt="Click on the map to see a live example" width="1291" height="564" /></a><p class="wp-caption-text">Click on the map to see a live example</p></div>
<p>You can see the <a href="https://github.com/Swizec/migrations-map/blob/de8800aecca4484f8c5827a82c8a746127264143/src/Maps.js#L69">full <code>World</code> component on Github</a>.</p>
<p>Happy hacking! ?</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-livecoding-34-map-global-migrations-part-3-54f","path":"/post/livecoding-34-map-global-migrations-part-3/"};window.dataPath="691/path---post-livecoding-34-map-global-migrations-part-3-54-f-ae4-nMeJXdnY5RH2Qxw1w6EVGCv20aU";/*]]>*/</script><script src="/swizecblog/webpack-runtime-fb9019140f39a903448b.js" async=""></script><script src="/swizecblog/app-e5d3c6935dd41a7392ed.js" async=""></script><script src="/swizecblog/0-7538a10af02717828d76.js" async=""></script><script src="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js" async=""></script></body></html>