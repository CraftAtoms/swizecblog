<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js"/><link as="script" rel="preload" href="/swizecblog/0-f215691c134019ee6fa5.js"/><link as="script" rel="preload" href="/swizecblog/app-49ff0b4ea28eff25fc3b.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-4f3a0bd1eef0c4ba11a9.js"/><link rel="preload" href="/swizecblog/static/d/601/path---post-writing-a-rest-client-in-haskell-20-c-6d4-xjEs6A60SqFjthXVea9YxSs9Rx8.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Writing a REST client in Haskell</h1><div><p>A few days ago I decided to buy some bitcoin. Then I noticed it fluctuates a lot despite a general upwards trend. Hmmm &#8230; if I just bought at the right moment and sold at a different right moment, I could make money fall out of the void!</p>
<p>I have since lost $5 by playing and gained $30 by leaving it alone. Obviously I suck at this &#8230;</p>
<p>I know! Let&#8217;s make a bot that does this! A low frequency trading bot, that sounds like fun. And let&#8217;s write it in <a class="zem_slink" title="Haskell (programming language)" href="http://haskell.org" rel="homepage" target="_blank">Haskell</a>, just to keep things interesting. Marrying the strictest of languages with the messiest of resources &#8211; the internet &#8230; what could possibly go wrong?</p>
<p>First order of business &#8211; a REST client.</p>
<h2>REST client</h2>
<p>Before my bot can do any trading and intricate <a class="zem_slink" title="Algorithmic trading" href="http://en.wikipedia.org/wiki/Algorithmic_trading" rel="wikipedia" target="_blank">algorithmic trading</a>, it needs to talk to the marketplace of choice. I picked Bitstamp because they&#8217;re the only ones that let me do this without a US bank account.</p>
<p>Writing a REST client in most languages is simple. Reading Bitstamp&#8217;s ticker in Python looks like this:</p>
<pre lang="python">import requests, json

r = requests.get("https://www.bitstamp.net/api/ticker")
print json.loads(r.content)
# prints: {u'volume': u'17179.28558844', u'last': u'159.49', u'bid': u'159.49', u'high': u'161.00', u'low': u'139.00', u'ask': u'159.64'}</pre>
<p>That&#8217;s it. Everything you need for a set of values nicely accessible as a dictionary.</p>
<p>In Haskell, well in Haskell figuring out how to do that took me all night, then a bit of the morning and finally a helpful tweet from a stranger to tell me just how I was misusing monads.</p>
<p>First of all, we are going to need a bunch of imports. The ones we <em>really</em> care about are the <em>http-conduit</em> library and the <em>Aeson</em> parser of <a class="zem_slink" title="JSON" href="http://json.org/" rel="homepage" target="_blank">JSON</a> strings. Everything else is there because &#8230; well I&#8217;m not sure actually, but it seems to be necessary, otherwise things don&#8217;t work.</p>
<pre lang="haskell">{-# LANGUAGE OverloadedStrings #-}

import Network.HTTP.Conduit
import Control.Monad.IO.Class
import Data.ByteString.Lazy
import Data.Aeson
import Data.Attoparsec.Number
import Control.Applicative
import Control.Monad.Trans</pre>
<p>I am not perfectly certain what the OverloadedStrings bit at the top does. It&#8217;s some sort of compiler directive and most haskell libraries I find in the wild tell me I will be a much happier man if I turn it on. Shrug.</p>
<p>All it takes now is making an <a class="zem_slink" title="Hypertext Transfer Protocol" href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" rel="wikipedia" target="_blank">HTTP request</a> and parsing the response as JSON. Simple, right?</p>
<p>Well, Haskell is strict and you can&#8217;t just parse things all willy nilly. We need to tell the parser what we expect, what we want to do with the result and what <em>type</em> it&#8217;s going to be. Can&#8217;t just have a bag of stuff! Nope, needs to be a well defined bag of things.</p>
<pre lang="haskell">data Ticker = Ticker
              { high :: Number,
                last :: Number,
                bid :: Number,
                volume :: Number,
                low :: Number,
                ask :: Number
              } deriving Show</pre>
<p>Great. We have a <em>Ticker</em> type that has a bunch of numbers and some names. That <em>Show </em>part seems to say that we&#8217;ll be able to print this out to the console. Smashing!</p>
<p>That&#8217;s not enough though, it is time for some strange hieroglyphics that tell <em>Aeson</em> how exactly parsing works.</p>
<pre lang="haskell">instance FromJSON Ticker where
  parseJSON (Object v) = Ticker 
                         v .: "high" 
                         v .: "last" 
                         v .: "bid" 
                         v .: "volume" 
                         v .: "low" 
                         v .: "ask"</pre>
<p>If I understand this correctly, those strange symbols are applicatives. The <em>.: </em>does &#8230; something &#8230; and the <em>&lt;$&gt; </em>and <em>&lt;*&gt; </em>do something else. The whole bit is about defining how to convert a key in the JSON string into a value in the <em>Ticker</em> type. I think.</p>
<p>Right, let&#8217;s make a function that will talk to the server and return a <em>Ticker </em>object. Maybe. If all goes well.</p>
<blockquote class="twitter-tweet"><p>@<a href="https://twitter.com/swizec">swizec</a> yes, you actually need to do something like this:ticker = get &#8220;ticker&#8221; &gt;&gt;= return . decode :: MonadIO m =&gt; m (Maybe Ticker)</p>
<p>— 蓮 (@k0001) <a href="https://twitter.com/k0001/status/326972349196926977">April 24, 2013</a></p></blockquote>
<pre lang="haskell">
ticker::(MonadIO m) => m (Maybe Ticker)
ticker = get "ticker" >>= return . decode</pre>
<p>Fairly simple stuff. Take something from the internet carefully wrapped in <em>MonadIO</em>, unwrap it for a bit, feed it into <em>decode</em>, which magically uses all the stuff we defined earlier, and wrap it back into both a <em>MonadIO</em> and a <em>Maybe.</em> Parsing can fail you know.</p>
<pre lang="haskell">
get::(MonadIO m) => String -> m ByteString
get url = simpleHttp $ "https://www.bitstamp.net/api/"++url</pre>
<p>This is the generalized <em>get</em> function that talks to Bitstamp using the <em>simpleHttp</em> function from <em>http-conduit</em>. It looks simple, but I&#8217;m sure a lot of hairy stuff is going on behind the scenes.</p>
<p>To make sure everything works, we run it.</p>
<pre lang="haskell">
main = do
  ticker >>= print</pre>
<p>Nothing.</p>
<p>Yup, the output we get is Nothing. It is at this point you realize <em>someone</em> isn&#8217;t using JSON correctly and all those numbers are actually strings. Strings. Now how the hell do you tell Haskell to automagically transform those into Numbers before putting them in the Ticker object?</p>
<p>Messy messy internet.</p>
<p>But hey! Got Haskell to talk to a <a class="zem_slink" title="Representational state transfer" href="http://en.wikipedia.org/wiki/Representational_state_transfer" rel="wikipedia" target="_blank">REST API</a>. How cool is that!?</p>
<div class="zemanta-pixie" style="margin-top: 10px; height: 15px;"><a class="zemanta-pixie-a" title="Enhanced by Zemanta" href="http://www.zemanta.com/?px"><img class="zemanta-pixie-img" style="border: none; float: right;" src="http://img.zemanta.com/zemified_e.png?x-id=5492ac2c-3abf-45a3-9680-dd8c31c07973" alt="Enhanced by Zemanta" /></a></div>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-writing-a-rest-client-in-haskell-20c","path":"/post/writing-a-rest-client-in-haskell/"};window.dataPath="601/path---post-writing-a-rest-client-in-haskell-20-c-6d4-xjEs6A60SqFjthXVea9YxSs9Rx8";/*]]>*/</script><script src="/swizecblog/webpack-runtime-4f3a0bd1eef0c4ba11a9.js" async=""></script><script src="/swizecblog/app-49ff0b4ea28eff25fc3b.js" async=""></script><script src="/swizecblog/0-f215691c134019ee6fa5.js" async=""></script><script src="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js" async=""></script></body></html>