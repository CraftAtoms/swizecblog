<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-9d5fb6538e5aeddeb728.js"/><link as="script" rel="preload" href="/swizecblog/0-ed8d8080a34ece5ef8f5.js"/><link as="script" rel="preload" href="/swizecblog/app-8e5a12ea225b4ed6ef6a.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-5246e3ca1a8c4f82e8dd.js"/><link rel="preload" href="/swizecblog/static/d/585/path---post-writing-modular-backbone-with-backbone-subroute-f-91-a5a-GMmFJIJzUZ1oxA4WR0VDXz01qJQ.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/blog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Writing modular Backbone with Backbone.SubRoute</h1><div><p>Working on a complicated frontend web app, Backbone soon becomes unwieldy. Routes definitions grow and grow, views steal each other&#8217;s actions and parts of the code try to become independent modules.</p>
<p>This is the problem I faced a few weeks ago while working on the fanciest signup funnel I ever helped create. Visitors would see the splash page, create their cart, revise it, sign up, add billing and shipping info, and finally checkout without ever refreshing the page.</p>
<p>A daunting challenge only made worse by the complexity of components involved. We needed a full-blown inventory listing, a full-blown cart editor and we even added some shiny bits to the billing and shipping forms. The funnel changes into an accordion after the first step.</p>
<p>Oh and the user can refresh at any point in the funnel without losing their place.</p>
<p>To divide work among the team, we took a straight-forward modular approach: a module handles the whole funnel, submodules take care of each step. This way everyone can focus on their own piece of the funnel and the javascript code can be reused when making the standalone versions of each step for signed-in users.</p>
<h2>The skeleton</h2>
<p><a href="http://geekdave.com/2012/04/05/module-specific-subroutes-in-backbone/">Backbone.SubRoute</a> makes this approach possible by letting you create Backbone routers attached at a certain path in the URL. By doing something like <code>var bla = new SubBla("/bla", â€¦)</code> you create a self-contained Backbone app that handles everything under <code>/bla</code> and doesn&#8217;t care about the outside world.</p>
<p>We didn&#8217;t like how the official docs recommend going about this, so we made it automagical-er.</p>
<p>A simple <code>app_skeleton.js</code> file holds the entire application together and loads modules when they&#8217;re needed.</p>
<pre lang="javascript">var YourApp = window.YourApp = {Routers: {}};

YourApp.Router = Backbone.Router.extend({
    routes: {
        "": "invokeRootModule",
        ":module(/*subroute)" : "invokeModule"
    },

    invokeRootModule: function () {
        this.invokeModule("root");
    },

    invokeModule: function (module, subroute) {
        module = module.toLowerCase().capitalize();

        if (!YourApp.Routers[module]) {
            YourApp.Routers[module] = 
                new YourApp[module].Router(module.toLowerCase()+"/",
                                           {createTrailingSlashRoutes: true});
        }
    }
});</pre>
<p>We agree to register all our modules as <code>window.YourApp.Module.Router</code>. This lets us put every module in its own file and creates a predictable interface for creating instances of sub routers.</p>
<p>That was easy, now all we need is a submodule.</p>
<h2>A module</h2>
<p>Modules work the same as standalone Backbone applications. They have views and collections and models and everything is held together by a router. You just have to conform to what app skeleton expects.</p>
<p>A simple module might look like this:</p>
<pre lang="javascript">(function ($) {
    YourApp.Root = {};

    YourApp.Root.Router = Backbone.SubRoute.extend({
        routes: {
            "(:step)": "step"
        },

        initialize: function () {
            // do stuff
        },

        step: function () {
            // something for this step
        }
    });

})(jQuery);</pre>
<p><code>Router</code> is the only necessary part. Everything else is added to taste. We rely on the router&#8217;s initialize function as the entry point into the module, so all initialization should happen in there.</p>
<h2>Sub sub modules</h2>
<p>Let&#8217;s make things interesting; the module is called <code>Root</code> because it&#8217;s going to handle submodules of its own &#8211; funnel steps in our case. <code>Root</code> loads them on the home page, <code>app_skeleton</code> loads them on standalone pages.</p>
<p>For some reason dynamically instantiating submodules was not an option in this case. Not sure why, but it probably had to do with listening to events between submodules. Yes, unclean, but there&#8217;s no reason to go overboard with architecture principles. Sometimes you just have to get shit done.</p>
<p>Root&#8217;s initialize becomes something like this:</p>
<pre lang="javascript">        initialize: function () {
            this.subrouters = {};

            this.subrouters.step1 = new YourApp.Step1.Router("base/step1/");
            this.subrouters.step2 = new YourApp.Step2.Router("base/step2/");
            // ...

            this.__listenToSubrouters();

            // other stuff
        },</pre>
<p>Every subrouter is instantiated on initialize. If we want to change our views when particular submodules are active, we have to listen to their <code>route</code> events because they steal routing from their parent. For instance, we had to make sure the accordion was visible, splash step was hidden and so on.</p>
<pre lang="javascript">        __listenToSubrouters: function () {
            _.keys(this.subrouters).map(_.bind(function (router) {
                this.listenTo(this.subrouters[router], 
                              "route", 
                              _.bind(function () { 
                                  this.step(router, "", 
                                                 {dont_navigate: true}); 
                              }, this));
            }, this));
        },</pre>
<p><code>__listenToSubrouters</code> goes through all the instantiated routers and makes sure to call the <code>step</code> function when a submodule does something.</p>
<p>The <code>step</code> function becomes something like this:</p>
<pre lang="javascript">        step: function(step, subpath, options) {
            // do view stuff here

            subpath = subpath || "";

            if (this.subrouters[step] &amp;&amp; !(options &amp;&amp; options.dont_navigate)) {
                this.subrouters[step].navigate(subpath, {trigger: true});
            }
        }</pre>
<p>This makes sure to <code>.navigate</code> subrouters when it&#8217;s appropriate and avoid doing so when the code is reacting to a subrouter&#8217;s <code>route</code> event. I&#8217;ve left out the view stuff because that isn&#8217;t very interesting.</p>
<h2>Win</h2>
<p>And there you go. Backbone with a modular design that keeps modules neat, encapsulated and reusable.</p>
<p>To make things even smoother I also added an event that triggers only when a certain step is fully visible. This helps submodules activate/deactivate their views properly because things like <a href="http://imakewebthings.com/jquery-waypoints/">jQuery Waypoints</a> don&#8217;t initialize well when elements aren&#8217;t at their final positions.</p>
<p>As for the super fancy signup process &#8211; you&#8217;ll be able to see it when <a href="http://www.dwellers.com/">Dwellers</a> launches. It&#8217;s pretty great.</p>
<div class="zemanta-pixie" style="margin-top: 10px; height: 15px;"><a class="zemanta-pixie-a" title="Enhanced by Zemanta" href="http://www.zemanta.com/?px"><img class="zemanta-pixie-img" style="border: none; float: right;" alt="Enhanced by Zemanta" src="http://img.zemanta.com/zemified_e.png?x-id=80eafc50-068a-4f40-acaf-a20b7ce2ed15" /></a></div>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-writing-modular-backbone-with-backbone-subroute-f91","path":"/post/writing-modular-backbone-with-backbone-subroute/"};window.dataPath="585/path---post-writing-modular-backbone-with-backbone-subroute-f-91-a5a-GMmFJIJzUZ1oxA4WR0VDXz01qJQ";/*]]>*/</script><script src="/swizecblog/webpack-runtime-5246e3ca1a8c4f82e8dd.js" async=""></script><script src="/swizecblog/app-8e5a12ea225b4ed6ef6a.js" async=""></script><script src="/swizecblog/0-ed8d8080a34ece5ef8f5.js" async=""></script><script src="/swizecblog/component---src-components-post-js-9d5fb6538e5aeddeb728.js" async=""></script></body></html>