<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecwp/component---src-components-post-js.a8953a73f94ec29b14b1.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.a8953a73f94ec29b14b1.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js"/><link as="script" rel="preload" href="/swizecwp/0-ce760dfe358fb4e73f84.js"/><link as="script" rel="preload" href="/swizecwp/app-affbd460d24d53f1fc4a.js"/><link as="script" rel="preload" href="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js"/><link rel="preload" href="/swizecwp/static/d/102/path---post-using-webpack-2-production-900-928-VBgMgJO8PpBfAAicFQGVz8Fc88.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecwp/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecwp/Thoughts/">Thoughts</a></ul></div><h1>Migrating to Webpack 2: some tips and gotchas</h1><div><blockquote class="twitter-tweet" data-width="550">
<p lang="en" dir="ltr">Question for the Javascript folk.<br />Have you upgraded Webpack to 2.x yet?</p>
<p>What are you using for &quot;real projects&quot; (work/?)?</p>
<p>&mdash; Erik Aybar (@erikthedev_) <a href="https://twitter.com/erikthedev_/status/818990904929349632">January 11, 2017</a></p></blockquote>
<p><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>Webpack 2.2 has reached <a href="https://github.com/webpack/webpack/releases/tag/v2.2.0-rc.4">release candidate 4</a>, the last pre-release version. Time to update!</p>
<p>My motivation was <em>&quot;Ugh, I&#39;m tired of these 3min+ local compile times. The amount of waiting is too damn high!&quot;</em> The new features are a nice bonus too.</p>
<p><center><a href="https://imgflip.com/i/1hh3ii"><img src="https://i.imgflip.com/1hh3ii.jpg" title="made at imgflip.com"/></a></center></p>
<p>After many days of fiddling, my Webpack is ready. Production compiles take 219 seconds instead of 226, and local dev compilation takes 152 seconds instead of 151. It’s not <em>that</em> worth it, but incremental compiles with Webpack in <code>watch</code> mode feel smooth as silk.</p>
<p>I love the new feature that highlights big files and tells you initial load sizes for different apps. I’ve been using it to eyeball different options, and I&#39;m sure it has bigger use cases, too. Fine-tuning code splitting perhaps?</p>
<img class="alignnone size-full wp-image-7354" src="https://swizec.com/blog/wp-content/uploads/2017/01/Screen-Shot-2017-01-11-at-00.37.00.png" width="775" height="311" srcset="https://swizec.com/blog/wp-content/uploads/2017/01/Screen-Shot-2017-01-11-at-00.37.00.png 775w, https://swizec.com/blog/wp-content/uploads/2017/01/Screen-Shot-2017-01-11-at-00.37.00-300x120.png 300w, https://swizec.com/blog/wp-content/uploads/2017/01/Screen-Shot-2017-01-11-at-00.37.00-768x308.png 768w" sizes="(max-width: 775px) 100vw, 775px" />
<img class="alignnone size-full wp-image-7355" src="https://swizec.com/blog/wp-content/uploads/2017/01/Screen-Shot-2017-01-11-at-00.38.28.png" width="446" height="117" srcset="https://swizec.com/blog/wp-content/uploads/2017/01/Screen-Shot-2017-01-11-at-00.38.28.png 446w, https://swizec.com/blog/wp-content/uploads/2017/01/Screen-Shot-2017-01-11-at-00.38.28-300x79.png 300w" sizes="(max-width: 446px) 100vw, 446px" />
<p>Then again, <code>rc4</code> just disabled these features by default &quot;because they&#39;re annoying&quot;. I liked it.</p>
<p>Webpack recommends keeping files under 250kB, which sounds like a lot, but it looks damn small compared to my code. Did you know 196kB of source ES6 compiles into about 920kB of browser-ready JavaScript? <em>With</em> minification, tree shaking, and dead code elimination! Without that, it&#39;s 2.3 megs. ?</p>
<p>The day when we ship raw ES6 code can&#39;t come soon enough.</p>
<p><em>BTW: Tree shaking removes unused dependencies (like when you import a whole library but just use a function or two), and dead code elimination removes code that&#39;s unreachable, like functions you never call.</em></p>
<p>So is upgrading to Webpack 2 even worth it?</p>
<p>Totally. Once they and the ecosystem <a href="https://github.com/webpack/webpack/issues/2867">resolve some issues</a>, tree shaking will ride eternal, shiny and chrome.</p>
<p>Here are some gotchas I discovered while upgrading.</p>
<h2>It&#39;s not quiiiiite ready yet (dependency hellish)</h2>
<p>You can use Webpack 2 in production. I&#39;m about to start.</p>
<blockquote class="twitter-tweet" data-width="550">
<p lang="en" dir="ltr"><a href="https://twitter.com/erikthedev_">@erikthedev_</a> <a href="https://twitter.com/TheLarkInn">@TheLarkInn</a> in the midst of upgrading our prod app to Webpack2.</p>
<p>Prob going live within the week.</p>
<p>&mdash; Swizec (@Swizec) <a href="https://twitter.com/Swizec/status/819004362231943168">January 11, 2017</a></p></blockquote>
<p><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>Although now that they’ve promised to release the final version in &lt; 10 days, I might wait. Or gently delay the code review and QA process until their release. We&#39;ll see 🙂</p>
<p>But here&#39;s one thing that&#39;s really awkward right now.</p>
<p>When you upgrade to Webpack 2.2.rc.x, you fall into a small dependency hell with <code>extract-text-webpack-plugin</code>. The released version depends on Webpack 2.1, which is silly. If you&#39;re going bleeding edge, you might as well go all the way, ya know?</p>
<p>So here&#39;s what you have to do:</p>
<pre lang="javascript">
// packages.json
"dependencies": {
  //...
    "extract-text-webpack-plugin": "git://github.com/webpack/extract-text-webpack-plugin#cbd4690",
    "webpack": "^2.2.0-rc.3"
</pre>
<p>I&#39;d show you the <code>npm install</code> command, but I don&#39;t know how to point at specific commits. See that <code>#cbd4690</code> hash? That&#39;s the exact commit that says <code>Add webpack 2 RC compatibility</code>.</p>
<p>This is fragile and a terrible idea. You <em>will</em> forget to update this dependency in the future, and it will continue to point at a random commit for the foreseeable future. Happens every time.</p>
<p><em>But</em> the published version on npm doesn&#39;t work. ? I assume they&#39;ll fix it for final release.</p>
<p>Why extract-text-webpack-plugin? It makes stylesheet imports better, I&#39;m told.</p>
<blockquote><p>
It moves every require(&quot;style.css&quot;) in entry chunks into a separate css output file. So your styles are no longer inlined into the javascript, but separate in a CSS bundle file (styles.css). If your total stylesheet volume is big, it will be faster because the stylesheet bundle is loaded in parallel to the javascript bundle.
</p></blockquote>
<p>See? Useful.</p>
<p>You also have to update <code>babel-loader</code> to at least <code>6.2.10</code>. That&#39;s when they added support for Webpack 2 rc. Not too bad.</p>
<h2>Funny config updates, but better docs</h2>
<p>The new Webpack 2 docs are <em>so much better</em>. Check out this wonderful <a href="https://webpack.js.org/guides/migrating/">Migrating from v1 to v2</a> official guide. You basically have to do a find &amp; replace, and you&#39;re done.</p>
<p>Just don&#39;t forget to take <code>&#39;&#39;</code> out of <code>resolve.extensions</code>. I don&#39;t remember why everyone needed that in the past, but I know that the new Webpack throws an error.</p>
<p>Error reports for bad configuration are also better now. That was fun to see. Loved it.</p>
<h2>CSS/Less and PostCSS plugin</h2>
<p>If you&#39;re not using Webpack to load CSS and compile Less or Sass, you should. It&#39;s made my life a lot easier. Especially the <a href="https://github.com/postcss/postcss">PostCSS</a> plugin makes your CSS easier to write.</p>
<p>Going from Webpack v1 to Webpack v2 involved many changes in this config. We used to have this:</p>
<pre lang="javascript">
// webpack.config.js
loaders: [
    // ...
        {
        test: /\.(less|css)$/,
        loader: ExtractTextPlugin.extract("style/useable", "css?sourceMap!postcss-loader!less-loader?sourceMap=true"),
        include: [
            path.resolve(__dirname, "app/assets/stylesheets")
        ]
    },

    {
        test: /\.css$/,
        loader: ExtractTextPlugin.extract("style/useable", "css?sourceMap!postcss-loader?sourceMap=true")
    },
    // ...
],
postcss: function () {
    return [
        precss,

        // UglifyJSPlugin mangles valid css during minfication. It is a known issue and this fix was obtained from: https://github.com/webpack/webpack/issues/666#issuecomment-184319770
        postcssImport({ addDependencyTo: webpack }),
        postcssURL(),
        postcssNext({
            browsers: ['last 2 versions', 'ie >= 9'],
            compress: true
        }),
        cssnano({zindex: false})
            // end UglifyJSPlugin fix
    ];
}
</pre>
<p>Which is probably too much config, but it worked. With Webpack v2 that&#39;s become more manageable and looks like this:</p>
<pre lang="javascript">
// webpack.config.js
    module: {
        rules: [
            {
                test: /\.(less|css)$/,
                use: [
                    ExtractTextPlugin.extract({
                        fallbackLoader: "style/useable",
                        loader: "style-loader"
                    }),
                    {
                        loader: 'css-loader?sourceMap',
                        query: {
                            modules: true,
                            importLoaders: 2
                        }
                    },
                    'postcss-loader?sourceMap',
                    'less-loader?sourceMap'
                ]
            },
        ]
    },
</pre>
<p>So much less code ?</p>
<p>That&#39;s because a lot of it is now in a different file called <code>postcss.config.js</code>. That one is a copypaste of the detailed config for postcss itself:</p>
<pre lang="javascript">
const webpack = require('webpack')

module.exports = {
    plugins: [
        // UglifyJSPlugin mangles valid css during minfication. It is a known issue and this fix was obtained from: https://github.com/webpack/webpack/issues/666#issuecomment-184319770
        require('postcss-import')({ addDependencyTo: webpack }),
        require('postcss-url'),
        require('postcss-cssnext')({
            browsers: ['last 2 versions', 'ie >= 9'],
            compress: true
        }),
        require('cssnano')({zindex: false})
            // end UglifyJSPlugin fix
    ]
}
</pre>
<p>I don&#39;t know if the <code>UglifyJS</code> bug we&#39;re working around still exists, so I left the config as I found it. Just to be safe.</p>
<p>Looking at code blobs is hard, so here&#39;s what happened:</p>
<ol>
<li>Webpack 2 no longer allows plugin-specific config keys like <code>postcss</code>. Everything must fit in the <code>rules.use</code> listing.</li>
<li>PostCSS now uses a separate config file called <code>postcss.config.js</code>. This works out of the box.</li>
<li>I removed separate rules for compiled and uncompiled CSS.</li>
<li>Everything goes in the <code>rules.use</code> array.</li>
<li><strong>Use rules evaluate last to first.</strong></li>
<li>First, we use <code>less-loader</code> to compile Less to CSS.</li>
<li>Then, we use <code>postcss-loader</code> to do the PostCSS changes.</li>
<li>Then, <code>css-loader</code> enables <code>import css from &#39;file.css&#39;</code>.</li>
<li>Finally, <code>ExtractTextPlugin</code> puts it in <code>&lt;style&gt;</code>.</li>
</ol>
<p>All of this used to be encoded in the loader bang syntax before: <code>css?sourceMap!postcss-loader!less-loader?sourceMap=true</code></p>
<p>Whomever came up with the <code>use: []</code> syntax, you&#39;re the best. I love the new approach.</p>
<h2>Tree shaking and optimization</h2>
<p>Now for the reason we&#39;re all here: tree shaking.</p>
<p>Webpack 2 understands native ES6 imports and uses them as split points. That means it can organize your code into different chunks so you&#39;re only loading the JavaScript that you&#39;re using.</p>
<p>What it <em>also</em> means is that it understands when you&#39;re importing more than you need. Combined with the <a href="https://www.npmjs.com/package/webpack-uglify-js-plugin">UglifyJsPlugin</a>, it can eliminate that extra code.</p>
<p>I spent a lot of time looking for what exactly turns this feature on. Turns Out™, it&#39;s on by default. Just Works™.</p>
<p>Here&#39;s what you have to do:</p>
<ol>
<li>Tell Babel <em>not</em> to compile imports into CommonJS (require stuff)</li>
<li>Enable UglifyJS</li>
</ol>
<pre lang="javascript">
// webpack.config.js
rules: [
    {
        test: /\.js$/,
        include: [
            path.resolve(__dirname, "app/assets/javascripts")
        ],
        exclude: [
            path.resolve(__dirname, "node_modules/")
        ],
        query: {
            plugins: ['transform-decorators-legacy',
                      'transform-runtime',
                      'transform-object-rest-spread',
                      'transform-react-constant-elements',
                      'transform-class-properties'],
            presets: [['es2015', {modules: false}], 'latest', 'react']
        },
        loader: 'babel-loader',
    },
]
// ...
plugins: [
    new webpack.optimize.UglifyJsPlugin({
        compress: {
            warnings: false,
            screw_ie8: true,
            conditionals: true,
            unused: true,
            comparisons: true,
            sequences: true,
            dead_code: true,
            evaluate: true,
            join_vars: true,
            if_return: true
        },
        output: {
            comments: false
        }
    }),
]
</pre>
<p>See that <code>{modules: false}</code> in the <code>babel-loader</code> config? That&#39;s new. You can specify options when defining Babel plugins and presets.</p>
<p><code>modules: false</code> tells the <code>es2015</code> preset to avoid compiling <code>import</code> statements into CommonJS. That lets Webpack do tree shaking on your code.</p>
<p>UglifyJsPlugin without extra config will do what we need, but I wanted to show you the options. It&#39;s <code>unused</code> and <code>dead_code</code> that enable tree shaking.</p>
<p><strong>However</strong>, we have to wait for the ecosystem to catch up. Most libraries are distributed with ES6 modules compiled to ES5, so in a real world scenario, <a href="https://github.com/webpack/webpack/issues/2867#issuecomment-271802246">you only get about 4% improvement</a>. ?</p>
<p>With Webpack 2 around the corner, this is sure to improve. Can&#39;t wait!</p>
<p>You should also split your code into Your Code and Everybody Else&#39;s code. Webpack docs have a great guide on <a href="https://webpack.js.org/guides/code-splitting-libraries/">Code Splitting for Libraries</a>.</p>
<p>Happy hacking ?</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-using-webpack-2-production-900","path":"/post/using-webpack-2-production/"};window.dataPath="102/path---post-using-webpack-2-production-900-928-VBgMgJO8PpBfAAicFQGVz8Fc88";/*]]>*/</script><script src="/swizecwp/webpack-runtime-7742d5ce65cd19570880.js" async=""></script><script src="/swizecwp/app-affbd460d24d53f1fc4a.js" async=""></script><script src="/swizecwp/0-ce760dfe358fb4e73f84.js" async=""></script><script src="/swizecwp/component---src-components-post-js-f2c2d6ca006cef019723.js" async=""></script></body></html>