<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js"/><link as="script" rel="preload" href="/swizecblog/0-7538a10af02717828d76.js"/><link as="script" rel="preload" href="/swizecblog/app-e5d3c6935dd41a7392ed.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-fb9019140f39a903448b.js"/><link rel="preload" href="/swizecblog/static/d/10/path---post-livecoding-16-canvas-drawimage-performance-is-weird-but-magical-8-cc-d2f-iva0N03qfo5XapRTQMwj2iXjHo.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/blog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Livecoding #16: canvas.drawImage performance is weird but magical</h1><div><p><em>This is a Livecoding Recap – an almost-weekly post about interesting things discovered while livecoding. Shorter than 500 words. With pictures. You can follow my channel, <a href="https://livecoding.tv/swizec">here</a>. New content almost <strong>every Sunday at 2pm PDT</strong>. There’s live chat ?</em></p>
<p><iframe src="https://www.livecoding.tv/swizec/videos/AVokn/embed" width="560" height="315" frameborder="0" scrolling="no" allowfullscreen="allowfullscreen"></iframe></p>
<p>This week, I had the charisma of a peeled potato. The livestream started with 6 people in the chat, and it ended with 2. Usually it ends with … more.</p>
<p>So sad.</p>
<p>BUT! We learned stuff about <code>canvas.drawImage</code>, <em>and</em> I poked around after the stream and made this glorious bastard. 14,000 smoothly animated particles! \o/</p>
<div style="width: 863px" class="wp-caption aligncenter"><img class="" src="http://i.imgur.com/eSfblPT.gif" alt="" width="853" height="567" /><p class="wp-caption-text">14,000 animated particle minions</p></div>
<p>Cool, huh? Such a shame it didn’t work during the stream. Then 3 people would’ve stayed!</p>
<p>The first thing we tried was the concept of sprites. Instead of doing <code>.arc</code> and <code>.stroke</code> for every particle, you do it once, then copy-pasta that particle to other places like this:</p>
<pre lang="javascript">
// draw a sprite particle in componentDidMount
this.context.beginPath();
this.context.arc(1.5, 1.5, 1, 0, 2*Math.PI, false);
this.context.stroke();

// copy pasta particle

drawParticle(particle) {
   let { x, y } = particle;

   this.context.drawImage(this.canvas, 0, 0, 3, 3, x, y, 3, 3);
}
</pre>
<p>Using <code>.drawImage</code> like this tells canvas to take pixels from the top left corner and copy them to a new place. A fast operation in theory, but something went wrong for us.</p>
<div style="width: 863px" class="wp-caption aligncenter"><img class="" src="http://i.imgur.com/902lShK.gif" alt="" width="853" height="567" /><p class="wp-caption-text">Slow drawImage</p></div>
<p>Terrible. Even worse than before. Copying those few pixels thousands of times grinds our animation to a halt. With a few thousand elements, each frame render takes a few seconds.</p>
<p>But at least the <code>.drawImage</code>. approach makes it easy to render arbitrary images instead of particles. Instead of using <code>this.canvas</code> as the source, you can use an arbitrary <code>Image()</code> object, which you can fill with an image from any URL on the internet.</p>
<div style="width: 863px" class="wp-caption aligncenter"><img class="" src="http://i.imgur.com/K3JIWBY.gif" alt="" width="853" height="567" /><p class="wp-caption-text">Minion Sprites</p></div>
<p>Strange … that feels smoother, doesn’t it? I’m not going crazy, right?</p>
<p>Anyway, there’s only one thing left to do: decouple physics from frame rate. A big part of why the animation feels so slow is that we only calculate new particle positions once per frame, which makes sense because we’re only drawing them once per frame.</p>
<p>Our frame rate is not up to snuff for that. We’re dropping frames, so we have to compensate for that in our calculation. The idea is that for each drawn frame, we have to pretend like multiple physics frames happened.</p>
<p>Fixing physics happens in the reducer and looks like this:</p>
<pre lang="javascript">
// reducer

case ‘TIME_TICK’:
        let {svgWidth, svgHeight, lastFrameTime} = state,
            newFrameTime = new Date(),
            multiplier = (newFrameTime-lastFrameTime)/(1000/60); // N frames dropped

        let movedParticles = state.particles
                                  .filter((p) => {
                                      return !(p.y > svgHeight || p.x < 0 || p.x > svgWidth);
                                  })
                                  .map((p) => {
                                      let [vx, vy] = p.vector;
                                      p.x += vx*multiplier;
                                      p.y += vy*multiplier;
                                      p.vector[1] += Gravity*multiplier;
                                      return p;
                                  });

        return Object.assign({}, state, {
            particles: movedParticles,
            lastFrameTime: new Date()
        });
</pre>
<p>We start by tracking timestamps for each frame and calculating a multiplier. Then, we multiply every position and vector change with the multiplier and voilà: time-based (instead of frame-based) physics.</p>
<div style="width: 863px" class="wp-caption aligncenter"><img class="" src="http://i.imgur.com/tQ1aiHw.gif" alt="" width="853" height="567" /><p class="wp-caption-text">Time-based Physics</p></div>
<p>So smooth! I had to increase the number of particles generated on every animation tick up to 2000 just to see anything interesting going on. Insane.</p>
<p>Mission accomplished, right? It’s smooth up to 8,000 particles, and we can’t push it to put more than that on-screen. But the minions wouldn’t stop niggling at me.</p>
<p>I wonder what happens if we put the minion sprite and the better physics together.</p>
<div style="width: 863px" class="wp-caption aligncenter"><img class="" src="http://i.imgur.com/JW4MSzk.gif" alt="" width="853" height="567" /><p class="wp-caption-text">Physics Minions</p></div>
<p>Ho boy! 14,000 smoothly animated minions! \o/</p>
<p>With a production build and a big screen, you can reach over 20,000 minions on screen, and it still looks smooth. <a href="http://swizec.github.io/react-particles-experiment/">Try it.</a></p>
<p>I have no idea why it’s faster to <code>drawImage</code> a complex .png than a circle. Or why it’s faster to <code>drawImage</code> an <code>Image()</code> object than a part of the canvas. It makes no sense, but here we are.</p>
<p>Do you know?</p>
<p>PS: the edited and improved versions of these videos are becoming a video course. Readers of the engineer package of <a href="http://swizec.com/reactd3js/">React+d3js ES6</a> get the video course for free when it’s ready.</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-livecoding-16-canvas-drawimage-performance-is-weird-but-magical-8cc","path":"/post/livecoding-16-canvas-drawimage-performance-is-weird-but-magical/"};window.dataPath="10/path---post-livecoding-16-canvas-drawimage-performance-is-weird-but-magical-8-cc-d2f-iva0N03qfo5XapRTQMwj2iXjHo";/*]]>*/</script><script src="/swizecblog/webpack-runtime-fb9019140f39a903448b.js" async=""></script><script src="/swizecblog/app-e5d3c6935dd41a7392ed.js" async=""></script><script src="/swizecblog/0-7538a10af02717828d76.js" async=""></script><script src="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js" async=""></script></body></html>