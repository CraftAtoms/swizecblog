<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-352e8466f0cbd742adc0.js"/><link as="script" rel="preload" href="/swizecblog/0-7538a10af02717828d76.js"/><link as="script" rel="preload" href="/swizecblog/app-e5d3c6935dd41a7392ed.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-bf7869bd5fe0e771eaf7.js"/><link rel="preload" href="/swizecblog/static/d/54/path---post-programatically-uploading-to-blobstore-in-python-35-a-b3d-YkK8cYMnO8VYxSwmv15K4kwzy4.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Programatically uploading to blobstore in python</h1><div><p>Officially this is something that cannot be done. Or rather that shouldn&#8217;t be done. When you look at the <a class="zem_slink freebase/en/google_app_engine" title="Google App Engine" rel="homepage" href="http://code.google.com/appengine/">google appengine</a> docs on &#8220;<a class="zem_slink freebase/en/uploading_and_downloading" title="Uploading and downloading" rel="wikipedia" href="http://en.wikipedia.org/wiki/Uploading_and_downloading">uploading</a> to blobstore&#8221; this is what they have to say:</p>
<blockquote><p>Blobs are useful for serving large files, such as video or image files, and for allowing users to upload large data files.</p>
<p>To prompt a user to upload a Blobstore value, your app presents a <a class="zem_slink freebase/guid/9202a8c04000641f8000000000955540" title="Form (web)" rel="wikipedia" href="http://en.wikipedia.org/wiki/Form_%28web%29">web form</a> with a file upload field.</p></blockquote>
<p>So ok, obviously the official documentation isn&#8217;t of much use here since it only talks about letting users upload files. But I needed something different. I needed to fetch an image from an url (gotten by intricate means, different story) and store it in the blobstore so it could later be served to many users. Obviously since <a class="zem_slink freebase/en/file_system" title="File system" rel="wikipedia" href="http://en.wikipedia.org/wiki/File_system">file access</a> isn&#8217;t permitted on appengine the only choice left was storing the file in the blobstore.</p>
<p>Naturally someone else has had this problem before right?</p>
<p>No. There are no solutions I could find online. None. Nada. Zilch. Niente.</p>
<p>After a few hours of hacking a week or so ago, however, I got it working.</p>
<p>Essentially the solution is to fake a form post to the blobstore url the <a class="zem_slink freebase/guid/9202a8c04000641f80000000163b3ef7" title="Application programming interface" rel="wikipedia" href="http://en.wikipedia.org/wiki/Application_programming_interface">API</a> creates. An interesting gotcha is that a redirect happens. Initially I thought I was making the form post right back to my application, but apparently you&#8217;re first posting to the blobstore, then the blobstore posts back to you. For some reason I couldn&#8217;t keep the associated meta-data to go through with the request so there&#8217;s an ugly-ish workaround that happens.</p>
<p>Another thing that&#8217;s important to note for this tutorial/howto is that I am using django-nonrel and that the initial event that starts the process is triggered by appengine&#8217;s task queue.</p>
<h4>The howto</h4>
<p>First, these are all the imports I&#8217;m using, there&#8217;s quite a few, so heh ðŸ™‚</p>
<pre lang="python">from django.http import HttpResponse, HttpResponseBadRequest, HttpRequest
from django.views.decorators.csrf import csrf_exempt
from django.conf import settings
from django.core.urlresolvers import reverse
import simplejson as json
import urllib2, urllib
from cStringIO import StringIO

from google.appengine.api.urlfetch import ResponseTooLargeError, DownloadError
from google.appengine.ext import blobstore
from google.appengine.api import urlfetch

from forms import ArticleProcForm
from models import Article
from lib import ImageExtractor
from lib import urllib2_file
from lib.urllib2_file import UploadFile
from lib.decorators import form_valid</pre>
<p>First thing that you&#8217;re going to need is the function that starts the whole process (in my case this is a django view)</p>
<pre lang="python">class ArticleProcForm(forms.Form):
    article = forms.IntegerField(required=True)

@csrf_exempt
@form_valid(ArticleProcForm, 'POST')
def article(request):
    try:
        article = Article.objects.get(id=request.form.cleaned_data['article'])
    except Article.DoesNotExist:
        return HttpResponse(json.dumps({'status': 'Bad Article'}))

    try:
        image_url = ImageExtractor.getImages(article.url)[0]['url']
    except IndexError:
        pass
    else:
        # important bit
        try:
            image = StringIO(urllib2.urlopen(image_url).read())
        except (urllib2.HTTPError, DownloadError):
            pass
        else:
            image = UploadFile(image, '.'.join([str(article.id), image_url.rsplit('.', 1)[1][:4]]))
            upload_url = blobstore.create_upload_url(reverse('Articles.views.upload'))

            try:
                urllib2.urlopen(upload_url, {'file': image})
            except (DownloadError, RequestTooLargeError):
                pass
        # end of important bit

    return HttpResponse(json.dumps({'status': 'OK'}))</pre>
<p>Here is basically what happens in the important bit:</p>
<ol>
<li>Download image from url and change it to a StringIO</li>
<li>Make an UploadFile (basically a bundle of <a class="zem_slink freebase/en/string" title="String (computer science)" rel="wikipedia" href="http://en.wikipedia.org/wiki/String_%28computer_science%29">byte-string</a>-data and desired filename)</li>
<li>Create an upload_url with the blobstore API</li>
<li>Fake a file-upload form post</li>
</ol>
<p>The next thing we need is a view that will handle the request the blobstore will send back to our app.</p>
<pre lang="python">@csrf_exempt
def upload(request):
    if request.method == 'POST':
        blobs = get_uploads(request, field_name='file', populate_post=True)

        article = Article.objects.get(id=int(blobs[0].filename.split('.')[0]))
        article.media = blobs[0].filename
        article.parsed = True
        article.save()

        return HttpResponseRedirect(reverse('Articles.views.upload'))
    else:
        return HttpResponse('meow')</pre>
<p>Basically it extracts the article&#8217;s id from the filename (the only way I could make work to pass that information) and stores some changes into the datastore. You&#8217;ll notice that I&#8217;m basically just storing the article&#8217;s id again in another field, this is to preserve knowledge of the file extension. It&#8217;s also important to note that the blobstore requires a redirect response upon success, otherwise it will throw an error.</p>
<p>Here is the get_uploads function I found online somewhere.</p>
<pre lang="python">def get_uploads(request, field_name=None, populate_post=False):
    """Get uploads sent to this handler.
    Args:
      field_name: Only select uploads that were sent as a specific field.
      populate_post: Add the non blob fields to request.POST
    Returns:
      A list of BlobInfo records corresponding to each upload.
      Empty list if there are no blob-info records for field_name.
    """

    if hasattr(request,'__uploads') == False:
        request.META['wsgi.input'].seek(0)
        fields = cgi.FieldStorage(request.META['wsgi.input'], environ=request.META)

        request.__uploads = {}
        if populate_post:
            request.POST = {}

        for key in fields.keys():
            field = fields[key]
            if isinstance(field, cgi.FieldStorage) and 'blob-key' in field.type_options:
                request.__uploads.setdefault(key, []).append(blobstore.parse_blob_info(field))
            elif populate_post:
                request.POST[key] = field.value
    if field_name:
        try:
            return list(request.__uploads[field_name])
        except KeyError:
            return []
    else:
        results = []
        for uploads in request.__uploads.itervalues():
            results += uploads
        return results</pre>
<p>Now the process of serving this blob to the browser is very simple and goes something like this:</p>
<pre lang="python">class ImageForm(forms.Form):
    id = forms.CharField(required=True)

@form_valid(ImageForm, 'GET')
@cache_response
def image(request):
    blob = BlobInfo.gql("WHERE filename='%s' LIMIT 1" % request.form.cleaned_data['id'])[0]

    return HttpResponse(BlobReader(blob.key()).read(),
                        content_type=blob.content_type)</pre>
<h4>One final note</h4>
<p>And one VERY important final note. The vanilla urllib2 library can&#8217;t handle file uploads, so I found one online that can. It&#8217;s called <a href="http://fabien.seisen.org/python/urllib2_file/">urllib2_file</a>.</p>
<p>However it doesn&#8217;t quite work on google appengine. For example it can&#8217;t handle being told what you want the filename to be and some other details because it relies on raw file access. So I changed it a little bit, unfortunately I don&#8217;t quite know how to upstream my changes so I&#8217;m hosting it on github.</p>
<p>You can get it <a href="http://github.com/Swizec/urllib2_file">at github</a>, feel free to contribute.</p>
<h6 class="zemanta-related-title" style="font-size: 1em;">Related articles by Zemanta</h6>
<ul class="zemanta-article-ul">
<li class="zemanta-article-ul-li"><a href="http://blog.notdot.net/2010/08/Using-BlobReader-wildcard-subdomains-and-webapp2">Using BlobReader, wildcard subdomains and webapp2 on Google AppEngine</a> (notdot.net)</li>
<li class="zemanta-article-ul-li"><a href="http://swizec.com/blog/django-protip-2-forms-are-awesome/swizec/1410">Django protip #2: Forms are awesome</a> (swizec.com)</li>
<li class="zemanta-article-ul-li"><a href="http://googleappengine.blogspot.com/2010/06/app-engine-sdk-135-released-with-new.html">App Engine SDK 1.3.5 Released With New Task Queue, Python Precompilation, and Blob Features</a> (googleappengine.blogspot.com)</li>
<li class="zemanta-article-ul-li"><a href="http://debuggable.com/posts/parsing-file-uploads-at-500-mb-s-with-node-js:4c03862e-351c-4faa-bb67-4365cbdd56cb">Parsing file uploads at 500 mb/s with node.js</a> (debuggable.com)</li>
</ul>
<div class="zemanta-pixie" style="margin-top: 10px; height: 15px;"><a class="zemanta-pixie-a" title="Enhanced by Zemanta" href="http://www.zemanta.com/"><img class="zemanta-pixie-img" style="border: none; float: right;" src="http://img.zemanta.com/zemified_e.png?x-id=82ae7610-8dea-47af-9e81-485f91ffacd6" alt="Enhanced by Zemanta" /></a><span class="zem-script more-related more-info pretty-attribution"><script src="http://static.zemanta.com/readside/loader.js" type="text/javascript"></script></span></div>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-programatically-uploading-to-blobstore-in-python-35a","path":"/post/programatically-uploading-to-blobstore-in-python/"};window.dataPath="54/path---post-programatically-uploading-to-blobstore-in-python-35-a-b3d-YkK8cYMnO8VYxSwmv15K4kwzy4";/*]]>*/</script><script src="/swizecblog/webpack-runtime-bf7869bd5fe0e771eaf7.js" async=""></script><script src="/swizecblog/app-e5d3c6935dd41a7392ed.js" async=""></script><script src="/swizecblog/0-7538a10af02717828d76.js" async=""></script><script src="/swizecblog/component---src-components-post-js-352e8466f0cbd742adc0.js" async=""></script></body></html>