<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js"/><link as="script" rel="preload" href="/swizecblog/0-f215691c134019ee6fa5.js"/><link as="script" rel="preload" href="/swizecblog/app-49ff0b4ea28eff25fc3b.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-4f3a0bd1eef0c4ba11a9.js"/><link rel="preload" href="/swizecblog/static/d/733/path---post-modeling-time-react-a-54-ca0-WH3Xb7eE5lcYehTOkJmnn3nczdo.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Modeling time in React</h1><div><img class="alignnone size-full wp-image-7198" src="https://swizec.com/blog/wp-content/uploads/2016/11/clock-example.gif" width="432" height="151" />
<p>Ever wanted to build a timer in React? It&#8217;s a tricky thing.</p>
<p>Ideally, React components rely only on their inputs ‚Äì the props ‚Äì so that they&#8217;re testable, reusable, and easier to understand. Time is the ultimate state, that global dependency that just won&#8217;t sit still.</p>
<p>Calling <code>new Date()</code> or <code>moment()</code> to get the current time in your component makes it dirty. You can&#8217;t test because it throws unpredictable results depending on system context. You can&#8217;t reuse and re-render either. Damn thing keeps changing!</p>
<p><em>And</em> you need some mechanism to keep refreshing that time state if you want your component to show something live. You can add a <code>setInterval</code> that runs <code>this.setState(moment())</code> every second, and that&#8217;s going to work. But if you show multiple timers on screen, they&#8217;re eventually going to diverge and look weird.</p>
<h2>Crib from system/hardware design</h2>
<p>Those problems have all been solved already in electronics and operating systems: it‚Äôs <a href="https://en.wikipedia.org/wiki/Clock_signal">the clock signal</a> in electronics and <a href="https://en.wikipedia.org/wiki/System_time">system time</a> in operating systems. Both reduce time to a stateful resource that everyone shares.</p>
<p>The idea is this:</p>
<ul>
<li>make a <code>Clock</code> store</li>
<li>emit an action every <code>period</code> milliseconds</li>
<li>share <code>Clock</code> with everyone</li>
</ul>
<p>With this approach, time becomes just another prop passed or injected into components that need it. Components themselves can treat it like an immutable value, which makes them easy to test, and because all components rely on the same <code>setInterval</code>, they&#8217;re never going to fall out of sync.</p>
<p>Let me show you.</p>
<img class="alignnone size-full wp-image-7199" src="https://swizec.com/blog/wp-content/uploads/2016/11/clock-actions.gif" width="432" height="258" />
<p>I&#8217;m going to use MobX, but the same approach should work with Redux and even the classical state-from-main-component-callbacks-up-components approach.</p>
<p>You can see <a href="https://github.com/Swizec/mobx-clock-example">the code on Github</a>.</p>
<h2>Clock store</h2>
<p>First, we need a <code>Clock</code> store. It looks like this:</p>
<pre lang="javascript">import { observable, action } from 'mobx';
import moment from 'moment';

class Clock {
    @observable time = moment();

    constructor(period = 1000) {
        this.interval = setInterval(() =&gt; this.clockTick(),
                                    period);
    }

    @action clockTick(newTime = moment()) {
        this.time = newTime;
    }
}

const clock = new Clock();

export default clock;
</pre>
<p>We have an <code>@observable</code> <code>time</code> property, which means MobX is going to communicate changes to any <code>observer</code>s. The <code>constructor</code> starts an interval with the specified period. In our case, this is going to be a 1Hz clock updating once per second.</p>
<p>We store the interval in <code>this.interval</code> so that we can stop it. This implementation doesn&#8217;t allow the clock to be stopped or reset, but it would be easy to add an action for that.</p>
<p>Each tick of the clock triggers an <code>@action</code> called <code>clockTick</code>, which updates the <code>time</code> property to the current time. MobX is smart enough to let us naively replace it with a new instance of <code>moment()</code>, and I&#8217;m sure Redux would be too.</p>
<p>The real trick to making this work is in the last two lines:</p>
<pre lang="javascript">const clock = new Clock();

export default clock;
</pre>
<p>We export <em>an instance of Clock</em>, not the class. This ensures that anywhere we use <code>import Clock</code>, we get the same singleton.</p>
<p><em>&#8220;But inject()! You can inject() and that will make a singleton!‚Äù</em> I hear you thinking.</p>
<p>Yes, but you can only <code>inject()</code> into React components. Sometimes <code>MobX</code> stores need access to The Clock as well. You can&#8217;t inject into those, but you <em>can</em> import stuff.</p>
<h2>Time display</h2>
<p><code>Clock</code> was the fun part. Let me show you that it&#8217;s easy to use üôÇ</p>
<p>We make a <code>Time*</code> component that displays durations. It can be a functional stateless component that takes <code>Clock</code> from React contexts via <code>inject()</code> and renders a thing.</p>
<pre lang="javascript">
const CurrentTime = inject('Clock')(observer(({ Clock }) => (
    <div>
        Current Time: <Duration d={Clock.time} />
    </div>
)));
</pre>
<p>Observes changes on <code>Clock</code> state and gets <code>Clock</code> from the context with <code>inject</code>. You could inject a static object with a <code>time = N</code> property when testing.</p>
<p>The <code>Duration</code> component takes a <code>moment()</code> object and displays it as a digital clock. Like this:</p>
<pre lang="javascript">const Duration = ({ d }) =&gt; {
    let h = d.hours(),
        m = d.minutes(),
        s = d.seconds();

    [h, m, s] = [h, m, s].map(n =&gt; n &lt; 10 ? `0${n}` : n);

    return <code>{h}:{m}:{s}</code>;
};
</pre>
<p>Take <code>hours</code>/<code>minutes</code>/<code>seconds</code> from the object, and prefix with a <code>0</code> when each is smaller than <code>10</code>. Yes, this breaks for negative values. It looks like this: <code>0-1:0-4:05</code>.</p>
<p>But that shouldn&#8217;t be hard to fix ?</p>
<p>In <a href="https://github.com/Swizec/mobx-clock-example">the full code</a>, I built a generalized <code>Time</code> displays that defers to <code>TimeSince</code>, <code>TimeUntil</code>, and <code>CurrentTime</code> as necessary. Their code is almost identical, so I didn&#8217;t want to explain it all here.</p>
<h2>Putting it together in App.js</h2>
<p>Now that you have a system <code>Clock</code> and a way to show <code>Time</code>, you can put it all together inside your <code>App</code> like this:</p>
<pre lang="javascript">
class App extends Component {
  render() {
      return (
          <Provider Clock={Clock}>
              <div className="App">
                  <DevTools />
                  <div className="App-intro">
                      <Time until={moment().add(10, 'minutes')} />
                      <Time since={moment().subtract(5, 'minutes')} />
                      <Time />
                  </div>
              </div>
          </Provider>
    );
  }
}
</pre>
<p><code>Provider</code> puts the <code>Clock</code> singleton in React context. This gives all your components access to the <code>Clock</code> via <code>inject()</code> and you can do anything you want with it.</p>
<p>Cool, isn&#8217;t it?</p>
<p><strong>And yes, it works in stores, too.</strong></p>
<p>Check this out from my Day Job code.</p>
<blockquote class="twitter-tweet" data-width="550">
<p lang="en" dir="ltr">MobX lets you do really cool things. when() might just be my fav feature. <a href="https://t.co/nGDwmsOJ2c">pic.twitter.com/nGDwmsOJ2c</a></p>
<p>&mdash; Swizec (@Swizec) <a href="https://twitter.com/Swizec/status/795798444094853121">November 8, 2016</a></p></blockquote>
<p><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>It&#8217;s in a store, <code>isOutOfTime</code> is a <code>@computed</code> property that compares <code>Clock.time</code> to some pre-defined deadline. <code>when()</code> the deadline passes, an <code>@action</code> is called.</p>
<pre lang="javascript">    @computed get timeLeft() {
        if (this.should_end_by) {
            return moment.duration(
                this.should_end_by
                                  .diff(Clock.time)
                          );
        }else{
            return null;
        }
    }

    @computed get isOutOfTime() {
        return !_.isNull(this.timeLeft) &amp;&amp; this.timeLeft &lt;= 0;
    }
</pre>
<p>Isn&#8217;t that cool? I think it&#8217;s cool. The code is easy to understand, easy to test, no messing around with intervals and relying on slippery system properties. Things just work‚Ñ¢.</p>
<p>It&#8217;s almost like your codebase is in a time monad ?</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-modeling-time-react-a54","path":"/post/modeling-time-react/"};window.dataPath="733/path---post-modeling-time-react-a-54-ca0-WH3Xb7eE5lcYehTOkJmnn3nczdo";/*]]>*/</script><script src="/swizecblog/webpack-runtime-4f3a0bd1eef0c4ba11a9.js" async=""></script><script src="/swizecblog/app-49ff0b4ea28eff25fc3b.js" async=""></script><script src="/swizecblog/0-f215691c134019ee6fa5.js" async=""></script><script src="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js" async=""></script></body></html>