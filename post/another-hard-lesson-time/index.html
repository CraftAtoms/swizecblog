<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js"/><link as="script" rel="preload" href="/swizecblog/0-f215691c134019ee6fa5.js"/><link as="script" rel="preload" href="/swizecblog/app-49ff0b4ea28eff25fc3b.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-b34af8fd410bb07c9828.js"/><link rel="preload" href="/swizecblog/static/d/735/path---post-another-hard-lesson-time-601-772-FxwG1kF2Qu3jDSxvNFvV1a3Xk.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Yet another hard lesson about time</h1><div><blockquote><p>
Yo Swiz, some users complained their exam ends immediately.
</p></blockquote>
<blockquote><p>
Hm… that&#39;s weird ?
</p></blockquote>
<p>So began my two day hunt for a bug.</p>
<p>To become a <a href="https://www.yup.com/become-tutor">Yup tutor</a>, you have to pass a subject exam: 25 questions about math, chemistry, or physics in 45 minutes. It&#39;s hard as hell; I tried.</p>
<img class="alignnone size-full wp-image-7383" src="https://swizec.com/blog/wp-content/uploads/2017/01/exam-timer.gif" width="348" height="73" />
<p>There&#39;s a timer in the corner ticking down. 45 minutes, and then you&#39;re done. A dialog shows up telling you time’s up. Easy peasy to build, right? Get a start time, add 45 minutes, count down. When timer hits zero, stop. 90% of the time, it works every time.</p>
<p>And then there’re <em>those</em> 7 people. For them, the timer hits zero 1 second after it starts. 45 minutes. Tick. Zero.</p>
<p>o.O</p>
<p>I looked through the code. No race conditions. You click Start, the server creates an exam, makes a <code>started_at</code> timestamp, adds 45 minutes, and tells the frontend when your exam should end. On every <a href="https://swizec.com/blog/modeling-time-react/swizec/7200">Clock tick</a>, the counter updates ,and a MobX observer checks if you&#39;re out of time.</p>
<img class="alignnone size-full wp-image-7384" src="https://swizec.com/blog/wp-content/uploads/2017/01/time-diagram-1.jpg" width="600" height="800" srcset="https://swizec.com/blog/wp-content/uploads/2017/01/time-diagram-1.jpg 600w, https://swizec.com/blog/wp-content/uploads/2017/01/time-diagram-1-225x300.jpg 225w" sizes="(max-width: 600px) 100vw, 600px" />
<p>Very straightforward.</p>
<p>We&#39;re using React and MobX, so the frontend behaves like a state machine. There&#39;s no way we&#39;re rendering stale views, no way for poorly garbage collected views to cause problems, and the more I played with the frontend state machine, the sturdier it looked.</p>
<p>Here&#39;s an excerpt:</p>
<pre lang="javascript">
class SubjectExam {
    constructor(user, subject) {
        when(() => this.isOutOfTime,
             () => {
                 if (!this.finished) {
                     this.finish();
                 }
             }
        );
    }
    
    @computed get isOutOfTime() {
        return !_.isNull(this.timeLeft) && this.timeLeft <= 0;
    }
    
    @computed get timeLeft() {
        if (this.should_end_by) {
            return moment.duration(moment.unix(this.should_end_by).diff(Clock.time));
        }else{
            return null;
        }
    }
}
</pre>
<p>MobX&#39;s <code>when</code> creates an autorun that checks the condition function, <code>() =&gt; this.isOutOfTime</code>, every time its value changes. When it evaluates to <code>true</code>, it runs the given function. In this case, that’s an action that finishes the subject exam.</p>
<p>The reason this works is hidden in <code>@computed timeLeft()</code>. It depends on <code>Clock.time</code>, which is a global MobX store that updates every second. It’s based on my <a href="https://swizec.com/blog/modeling-time-react/swizec/7200">Modeling time in React &amp; MobX</a> approach.</p>
<p>Diffing the server-provided <code>should_end_by</code> timestamp and <code>Clock.time</code> tells us how much time is left. It works great and produces a countdown timer when you add some rendering.</p>
<p>The nice feature of this approach is that the timer is stable. You can refresh and navigate the page as much as you want. The server calculates the time, so it doesn&#39;t care.</p>
<p>But… those 7 people… why was the time up after 1 second? Can you guess?</p>
<p>I found no pattern in who the applicants were, when they took the exam, what timezone they were in, or which browser they used. It&#39;s not a bug in MomentJS. None of the cases happened around a DST, day, month, or year boundary.</p>
<p><em>It should work.</em></p>
<p>?</p>
<p>The only remaining explanation is that their system time was waaaaaayyy in the future. More than 45 minutes. I don&#39;t know why their computers thought they were in the future, but it&#39;s the only explanation that works.</p>
<p>How do you fix it?</p>
<p>You don&#39;t rely on user time. Instead of calculating a <code>should_end_by</code> timestamp on the server, calculate the delta. Look only at the delta when doing a countdown.</p>
<p>Like this:</p>
<img class="alignnone size-full wp-image-7385" src="https://swizec.com/blog/wp-content/uploads/2017/01/time-diagram-2.jpg" width="600" height="800" srcset="https://swizec.com/blog/wp-content/uploads/2017/01/time-diagram-2.jpg 600w, https://swizec.com/blog/wp-content/uploads/2017/01/time-diagram-2-225x300.jpg 225w" sizes="(max-width: 600px) 100vw, 600px" />
<p>The exam starts, the server looks at current time and returns <code>45min</code>. User reloads, server looks at current time, calculates delta from start time, returns new time remaining.</p>
<p>On the frontend, you create a local <code>shouldEndAt</code> timestamp when you load the exam – <code>time + delta_from_server</code> – then count down from there.</p>
<p>Lesson learned. Time is so hard that you can&#39;t even rely on people&#39;s clocks being accurate to within 1 hour. Add it to the <a href="http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">Falsehoods Programmers Believe About Time</a> pile.</p>
<p>?</p>
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-another-hard-lesson-time-601","path":"/post/another-hard-lesson-time/"};window.dataPath="735/path---post-another-hard-lesson-time-601-772-FxwG1kF2Qu3jDSxvNFvV1a3Xk";/*]]>*/</script><script src="/swizecblog/webpack-runtime-b34af8fd410bb07c9828.js" async=""></script><script src="/swizecblog/app-49ff0b4ea28eff25fc3b.js" async=""></script><script src="/swizecblog/0-f215691c134019ee6fa5.js" async=""></script><script src="/swizecblog/component---src-components-post-js-dbedf083f25f7ad1f3b1.js" async=""></script></body></html>