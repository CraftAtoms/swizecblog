<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/swizecblog/component---src-components-post-js.345c7c4f16662f410581.css">@import url(https://fonts.googleapis.com/css?family=Lora);
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:Lora,serif}body{background-color:#f6f6f6;margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:Lora,serif;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{-moz-font-feature-settings:"kern","liga","clig","calt";-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:Lora,serif;font-feature-settings:"kern","liga","clig","calt";font-kerning:normal;font-weight:400;word-wrap:break-word}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:Lora,serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem;padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem;word-wrap:normal}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:Lora,serif;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}

/*# sourceMappingURL=component---src-components-post-js.345c7c4f16662f410581.css.map*/</style><style data-styled-components="cEsjyT hklXLQ gpHXOM cTUdjA">
/* sc-component-id: sc-bdVaJa */
.cEsjyT{margin:3rem auto;max-width:960px;padding:1.25rem 1rem;} .cEsjyT ul{margin:0 0 0px 0;list-style:none;float:right;}
/* sc-component-id: sc-bwzfXH */
.cTUdjA{-webkit-text-decoration:none;text-decoration:none;text-align:right;margin:0 .5rem 0 .5rem;padding:10px;color:#7c51a1;} .cTUdjA:hover{color:#fff;background-color:#7c51a1;}
/* sc-component-id: sc-htpNat */
.gpHXOM{-webkit-text-decoration:none;text-decoration:none;color:black;} .gpHXOM:hover{-webkit-text-decoration:underline;text-decoration:underline;color:#7c51a1;} .gpHXOM h3{display:inline;font-size:30px;}
/* sc-component-id: sc-bxivhb */
.hklXLQ{margin:0 3rem 4.5rem;}</style><title data-react-helmet="true">Swizec Blog</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><link as="script" rel="preload" href="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js"/><link as="script" rel="preload" href="/swizecblog/0-7538a10af02717828d76.js"/><link as="script" rel="preload" href="/swizecblog/app-e5d3c6935dd41a7392ed.js"/><link as="script" rel="preload" href="/swizecblog/webpack-runtime-fb9019140f39a903448b.js"/><link rel="preload" href="/swizecblog/static/d/48/path---post-advent-code-day-22-sporifica-virus-352-a1d-mrLr1xnWdMSN3gpbB4zfoHq6g.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div><div class="sc-bdVaJa cEsjyT"><div class="sc-bxivhb hklXLQ"><a class="sc-htpNat gpHXOM" href="/swizecblog/blog/"><h3>Swizec Teller</h3></a><ul><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Business/">Business</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Personal/">Personal</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Technical/">Technical</a><a class="sc-bwzfXH cTUdjA" href="/swizecblog/Thoughts/">Thoughts</a></ul></div><h1>Advent of Code Day 22 ‚Äì Sporifica Virus</h1><div><p><iframe width="580" height="326" src="https://www.youtube.com/embed/prdKoJ5B5z8?feature=oembed" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe></p>
<p>For Day 22, we built a virus and found that Safari is much faster than Chrome.</p>
<blockquote><p>
The virus carrier works in bursts; in each burst, it wakes up, does some work, and goes back to sleep. The following steps are all executed in order one time each burst:
</p></blockquote>
<ol>
<li>Turn left if current cell is infected, turn right if it isn&#8217;t.</li>
<li>Flip the cell (clean ‚Äì&gt; infected, infected ‚Äì&gt; clean)</li>
<li>Move forward</li>
</ol>
<blockquote><p>
Diagnostics have also provided a map of the node infection status (your puzzle input). The virus carrier begins in the middle of the map facing up.
</p></blockquote>
<p>Naturally, I decided to solve this puzzle in React. Because it sounds like it might draw something interesting. And who doesn&#8217;t want to see a visualization of the spread of a deadly virus?</p>
<p>It draws a dick. üòë</p>
<blockquote class="twitter-tweet" data-width="550">
<p lang="en" dir="ltr">Generative dick art in 32,400 divs. Enjoy <a href="https://t.co/ZXywfcbry7">pic.twitter.com/ZXywfcbry7</a></p>
<p>&mdash; Swizec (@Swizec) <a href="https://twitter.com/Swizec/status/944147668535730176?ref_src=twsrc%5Etfw">December 22, 2017</a></p></blockquote>
<p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>And takes 5 minutes to run. And gets the wrong result.</p>
<p><strong>Edit:</strong>  I mixed up left and right. When you fix left and right, it no longer draws a dick, and it still gets the wrong answer ü§∑‚Äç‚ôÄÔ∏è. <strong>/Edit</strong></p>
<p>There must be an off-by-one error somewhere in the code that I can&#8217;t find. The animation looks correct.</p>
<p>The image evolves, the virus carrier seems to follow the rules, and there are no obvious digressions from the plan. The recursive pattern it falls into around step 7,000 looks suspicious but not out of the question ü§î</p>
<h2>An attempt was made (and then fixed)</h2>
<p>You can <a href="https://github.com/Swizec/advent-of-code-2017/blob/master/22/src/Day22.js">see the code on GitHub</a>.</p>
<img class="alignnone size-full wp-image-7994" src="https://swizec.com/blog/wp-content/uploads/2017/12/image.png" width="968" height="762" srcset="https://swizec.com/blog/wp-content/uploads/2017/12/image.png 968w, https://swizec.com/blog/wp-content/uploads/2017/12/image-300x236.png 300w, https://swizec.com/blog/wp-content/uploads/2017/12/image-768x605.png 768w" sizes="(max-width: 968px) 100vw, 968px" />
<p>It&#8217;s built from 3 React components: <code>GridRow</code>, which renders a single row of the grid, <code>Grid</code>, which renders the grid, and <code>Day22</code>, which drives the whole thing.</p>
<h3>GridRow</h3>
<p>If you guessed <em>&#8220;Oh, that should be simple&#8221;</em>, you were right.</p>
<pre lang="javascript">
const GridRow = ({ row, x, y, ry }) =>
    row.map((cell, i) => (
        <div
            style={{
                background:
                    y === ry &#038;&#038; x === i
                        ? "red"
                        : cell === "#" ? "black" : "white",
                width: "5px",
                height: "5px",
                display: "inline-block"
            }}
            key={i}
        >
            &nbsp;
        </div>
    ));
</pre>
<p>Loop through a row, which is an array, and render a <code>&lt;div&gt;</code> for each <code>cell</code>. Cells are 5&#215;5 pixels and their background can be <code>red</code>, <code>black</code> or <code>white</code>.</p>
<p>Red if the virus carrier is currently on that cell, black if the cell is infected, white if it&#8217;s not.</p>
<h3>Grid</h3>
<p>Once more a simple one, walk through an array of rows, render <code>GridRow</code> components.</p>
<pre lang="javascript">
const Grid = ({ grid, x, y }) =>
    grid.map((row, i) => (
        <div key={i} style={{ display: "flex", justifyContent: "center" }}>
            <GridRow row={row} x={x} y={y} ry={i} />
        </div>
    ));
</pre>
<h3>Day 22 ‚Äì the actual solution</h3>
<p><code>&lt;Day22&gt;</code> is where all the logic happens. It sets up our grid as data, drives the virus carrier, and renders <code>&lt;Grid&gt;</code> and some meta data.</p>
<pre lang="javascript">
const Width = 180,
    offset = 23;
    
class Day22 extends Component {
    state = {
        grid: new Array(Width).fill(".").map((_, i) => {
            let row =
                i > Math.floor(Width / 2 - input.length / 2 - offset)
                    ? input[
                          i - Math.floor(Width / 2 - input.length / 2 - offset)
                      ]
                    : null;

            let a = new Array(Width).fill(".");
            if (row) {
                a.splice(
                    Width / 2 - row.length / 2 + offset,
                    row.length,
                    ...row
                );
            }
            return a;
        }),
        x: Math.floor(Width / 2) + offset,
        y: Math.floor(Width / 2) - offset,
        vx: 0,
        vy: -1,
        bursts: 0,
        infected: 0
    };

    componentDidMount() {
        this.burstActivity();
    }

    burstActivity() {
            // snip
    }

    turnLeft(vx, vy) {
        // snip
    }

    turnRight(vx, vy) {
        // snip
    }

    render() {
        const { grid, width, bursts, x, y, infected } = this.state;

        return (
            <div>
                <h3 style={{ display: "flex", justifyContent: "center" }}>
                    bursts: {bursts}, pos: ({x}, {y}), infected: {infected}
                </h3>
                <div style={{ border: "1px solid red" }}>
                    <Grid grid={grid} x={x} y={y} />
                </div>
            </div>
        );
    }
}
</pre>
<p>That <code>state</code> calculation looks hairy. We&#8217;re taking an array of <code>Width</code>, filling it with healthy cells, <code>.</code>, then walking through it to build <code>row</code>s. If the current index is past a certain point, we replace the middle part of the <code>row</code> with a row from our input array. We do that with a <code>splice</code>.</p>
<p>The result is a 180&#215;180 grid of cells. Some of them are infected, but most aren&#8217;t.</p>
<p>The <code>render</code> method just renders all of this.</p>
<h3>The virus carrier logic</h3>
<p>The virus carrier logic comes in 3 functions. <code>burstActivity</code>, <code>turnLeft</code> and <code>turnRight</code>.</p>
<pre lang="javascript">
   burstActivity() {
        const { x, y, bursts, grid } = this.state;
        let { vx, vy, infected } = this.state;

        if (grid[y][x] === "#") {
            grid[y][x] = ".";

            [vx, vy] = this.turnRight(vx, vy);
        } else {
            grid[y][x] = "#";
            infected += 1;

            [vx, vy] = this.turnLeft(vx, vy);
        }

        this.setState({
            x: x + vx,
            y: y + vy,
            vx,
            vy,
            grid,
            infected,
            bursts: bursts + 1
        });
        if (bursts + 1 < 10000) {
            requestAnimationFrame(() => this.burstActivity());
        }
    }

    turnLeft(vx, vy) {
        let _vx = -1 * vy;
        vy = vx;
        return [_vx, vy];
    }

    turnRight(vx, vy) {
        let _vx = vy;
        vy = -1 * vx;
        return [_vx, vy];
    }
</pre>
<p><code>burstActivity</code> is our main logic driver. It looks at the current virus carrier position, turns left if it&#8217;s infected, or turns right if it isn&#8217;t. In both cases, it also flips the cell.</p>
<p>If the cell was flipped to infected, we increment our solution counter of how many cells we&#8217;ve infected.</p>
<p>Then it updates state and continues the loop if there have been fewer than 10,000 bursts of activity.</p>
<p><code>turnLeft</code> and <code>turnRight</code> turn the direction our virus carrier is going. Left or right using a little bit of vector maths. Thanks to a helpful stream watcher who showed me this better way. I had a huge sequence of ifs at first üôà</p>
<h2>Lessons learned</h2>
<p>I learned a couple of lessons with this build.</p>
<ol>
<li>React is SO MUCH FASTER after you turn off streaming</li>
<li>If you render 250,000 DOM nodes, you&#8217;re gonna have a bad time</li>
<li>Pegging your algorithm at <code>requestAnimationFrame</code> makes it slow</li>
<li>Safari is <em>a lot faster</em> than Chrome at re-rendering a few ten thousand DOM nodes with React. I don&#8217;t know why</li>
</ol>
<blockquote class="twitter-tweet" data-width="550">
<p lang="en" dir="ltr">It&#39;s surprising how much faster than Chrome Safari is at re-rendering a 180&#215;180 div array in React on every requestAnimationFrame</p>
<p>I triedFirefox too but it was laughably slow. Yes the new super fast Firefox.</p>
<p>Maybe I should switch to Safari ü§î <a href="https://t.co/tqyCA3y5ML">pic.twitter.com/tqyCA3y5ML</a></p>
<p>&mdash; Swizec (@Swizec) <a href="https://twitter.com/Swizec/status/944241764029816832?ref_src=twsrc%5Etfw">December 22, 2017</a></p></blockquote>
<p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<ol>
<li>When your code runs slow, development is slow, and getting the wrong result after 2+ hours of tinkering kinda sucks</li>
<li><code>array.splice(5, undefined, 1,2,3,4,5)</code> doesn&#8217;t even bat an eye, turns that <code>undefined</code> into <code>0</code> and proceeds like nothing happened</li>
</ol>
<blockquote class="twitter-tweet" data-width="550">
<p lang="en" dir="ltr">This &quot;works&quot; <a href="https://twitter.com/hashtag/javascript?src=hash&amp;ref_src=twsrc%5Etfw">#javascript</a> <a href="https://t.co/p0RSmrLore">pic.twitter.com/p0RSmrLore</a></p>
<p>&mdash; Swizec (@Swizec) <a href="https://twitter.com/Swizec/status/944122955876900866?ref_src=twsrc%5Etfw">December 22, 2017</a></p></blockquote>
<p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>Thanks to stream watchers for pointing out that I can&#8217;t spell <code>row.length</code>. You da real MVPs.</p>
<img src="https://media.giphy.com/media/l0MYvHFJkgm1fnuko/giphy.gif" />
</div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-components-post-js","jsonName":"post-advent-code-day-22-sporifica-virus-352","path":"/post/advent-code-day-22-sporifica-virus/"};window.dataPath="48/path---post-advent-code-day-22-sporifica-virus-352-a1d-mrLr1xnWdMSN3gpbB4zfoHq6g";/*]]>*/</script><script src="/swizecblog/webpack-runtime-fb9019140f39a903448b.js" async=""></script><script src="/swizecblog/app-e5d3c6935dd41a7392ed.js" async=""></script><script src="/swizecblog/0-7538a10af02717828d76.js" async=""></script><script src="/swizecblog/component---src-components-post-js-a296f4540b7641f60fd0.js" async=""></script></body></html>