{"data":{"wordpressPost":{"title":"How We Used Webpack to Reduce Our JS Footprint by 50","content":"<p><iframe width=\"853\" height=\"480\" src=\"https://www.youtube.com/embed/wIh7xTBZbow\" frameborder=\"0\" allowfullscreen></iframe></p>\n<p>In this article, I&#39;m going to show you how we went <strong>from 30 requests for 3.1MB</strong> of minified uncompressed JavaScript <strong>to 19 requests for 2.2MB</strong> of minified uncompressed JS. Why uncompressed? Because Rails doesn&#39;t gzip on localhost, and our production servers are running the new setup already.</p>\n<p>We weren&#39;t doing anything stupid before. Tree shaking, minification, code splitting to avoid JavaScript users don&#39;t need… we had all of that. We even split our frontend into 5 or 6 discreet apps, each with its own internal code splitting.</p>\n<p>And yet, 30 requests for 3.1MB.</p>\n<p>Our problem: Third-party libraries. There&#39;s a bunch of stuff that we need, like Backbone and Handlebars and Lodash and jQuery and so on. Most of them we loaded from public CDN. Some of them we bundled locally into a <code>vendor.js</code> file; this is where the huge size came from.</p>\n<p>You see, when all your apps share a <code>vendor.js</code> file, and some of them are React and some are Backbone, guess what happens? All apps load both React <em>and</em> Backbone.</p>\n<p>We achieved this vendor/app split following <a href=\"https://webpack.js.org/guides/code-splitting-libraries/\">Webpack&#39;s official guide on code splitting libraries</a>. It suggests using the <code>CommonChunksPlugin</code> to extract common code into a top-level file.</p>\n<pre lang=\"javascript\">\n    plugins: [\n        // Avoid publishing files when compilation failed:\n        new webpack.NoEmitOnErrorsPlugin(),\n        new ExtractTextPlugin( envConfig.inDevelopment() ?  \"[name]_style.css\" : \"[name]_style.[chunkhash].css\"),\n        new webpack.optimize.CommonsChunkPlugin({\n            names: ['vendor', 'manifest'],\n        })\n    ]\n</pre>\n<p><code>manifest.js</code> is meant to contain Webpack&#39;s runtime, and <code>vendor.js</code> contains your more stable third-party dependencies. This is meant to improve caching. <em>shrug</em></p>\n<p>On top of that, we had a bunch of global libraries configured as externals and loaded them in top-level <code>&lt;script&gt;</code> tags. Not a bad approach per se, but something like the AWS SDK is almost 500kb of <em>compressed</em> JavaScript. When you&#39;re using only one function… yeah, no bueno.</p>\n<p>We fixed this situation with a 2-pronged approach:</p>\n<ul>\n<li>bundle and tree shake all our dependencies ourselves</li>\n<li>create a different vendor file for each app (entry file)</li>\n</ul>\n<p>Here&#39;s how that looks:</p>\n<pre lang=\"javascript\">\nconst Apps = {\n    // list entries\n    // will be reused as Webpack's entry config\n};\n\n// previously loaded as externals\nconst GlobalModules = _.map({\n    jquery: ['$', 'jQuery', 'window.jQuery'],\n    lodash: ['_'],\n    backbone: ['Backbone'],\n    'backbone-validation': ['Backbone.Validation'],\n    'raven-js': ['Raven'],\n    moment: ['moment'],\n    string: ['string', 'S'],\n    async: ['async']\n}, (vars, module) => new webpack.ProvidePlugin(\n    _.fromPairs(vars.map(v => [v, module]))\n));\n\n// updated plugins config\n    plugins: [\n        new webpack.NoEmitOnErrorsPlugin(),\n        new ExtractTextPlugin( envConfig.inDevelopment() ? \"[name]_style.css\"\n                                                         : \"[name]_style.[chunkhash].css\"\n        ),\n    ].concat(\n        GlobalModules\n    ).concat(\n        Object.keys(Apps)\n              .map(app => new webpack.optimize.CommonsChunkPlugin({\n                  name: `${app}_vendor`,\n                  chunks: [app],\n                  minChunks: isVendor\n              }))\n    ).concat([\n        new webpack.optimize.CommonsChunkPlugin({\n            name: 'manifest',\n            chunks: Object.keys(Apps).map(n => `${n}_vendor`),\n            minChunks: (module, count) => {\n                return count >= Object.keys(Apps).length && isVendor(module)\n            }\n        })\n    ])\n</pre>\n<p>All our <code>entry</code> files, or apps as we call them, go in <code>Apps</code>. This helps us iterate over them when building the <code>plugins</code> config.</p>\n<p>What used to be externals loaded in global <code>script</code> tags become <code>GlobalModules</code>. Each is translated into a <code>ProvidePlugin</code> configuration, which essentially replaces all occurrences of <code>$</code> with <code>require('jquery')</code>, <code>moment</code> with <code>require('moment')</code>, and so on.</p>\n<p>With this approach, we don&#8217;t have to change any code that relies on global libs&#8217; availability.</p>\n<p>Armed with these vars, we dynamically generate a list of Webpack <code>plugins</code>. Each app gets its own vendor file – <code><app>_vendor.js</code> – and at the end, all files together get a common <code>manifest</code> file with the Webpack runtime. Again, to prevent cache churning.</p>\n<p>Oh, and there&#8217;s the helpful <code>isVendor</code> function, which I got from <a href=\"https://leanpub.com/survivejs-webpack\">Juho&#8217;s SurviveJS &#8211; Webpack</a> book. You should buy it. It&#8217;s great.</p>\n<pre lang=\"javascript\">\nfunction isVendor(module, count) {\n    const userRequest = module.userRequest;\n\n    return userRequest && userRequest.indexOf('node_modules') >= 0;\n}\n</pre>\n<p>This function tells us if a specific module is a third-party library or our own code. It&#39;s third party if it&#39;s in <code>node_modules</code>, and our own code if it&#39;s not.</p>\n<p>I hope this helps make your website faster. It got our page speed score from 54 to 95 ?</p>\n<p>PS: This article is a spiritual successor to <a href=\"https://swizec.com/blog/using-webpack-2-production/swizec/7356\">Migrating to Webpack 2: some tips and gotchas</a>.</p>\n"},"site":{"siteMetadata":{"title":"Swizec Blog","subtitle":"Fetch Data From Local WP Install"}}},"pageContext":{"id":"fc099a6e-40c9-5eb0-a7d8-87ac211824cd"}}