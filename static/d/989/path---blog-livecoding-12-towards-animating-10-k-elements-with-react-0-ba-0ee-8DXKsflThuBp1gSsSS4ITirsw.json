{"data":{"wordpressPost":{"title":"Livecoding #12: towards animating 10k+ elements with React","content":"<p><em>This is a Livecoding Recap &#8211; an almost-weekly post about interesting things discovered while livecoding. It is shorter than 500 words. There are pictures. You can follow my channel, <a href=\"https://www.livecoding.tv/swizec/\">here</a>. New stuff shows up almost <strong>every Sunday at 2pm PDT</strong>. There’s live chat 😉</em></p>\n<p>Welcome to the first Livecoding Recap. This recap is for the 12th live coding. I don’t have an excuse for not recapping before now. It just took me this long to realize <em>“These are fun, and I learn a lot. I should turn them into short blogposts.”</em></p>\n<p><center><iframe src=\"https://www.livecoding.tv/swizec/embed\" width=\"560\" height=\"315\" frameborder=\"0\" allowfullscreen=\"true\" scrolling=\"no\"></iframe></center></p>\n<p>This Sunday, I started a new quest: To find the definitive answer to <em>&#8220;How do you smoothly animate 10,000 elements in React?”</em>.</p>\n<p>Many people have asked me about this recently, and I realized I couldn’t give them a good answer. The best I could come up with was, <em>“Try to render fewer nodes?”</em>. The issue is that sometimes you really <em>do</em> need that many nodes because you don’t want to sacrifice fidelity.</p>\n<p>So I took my old <a href=\"http://swizec.com/blog/animating-with-react-redux-and-d3/swizec/6775\">particle generator experiment</a> and started playing around. It doesn’t use a lot of d3, but it does rely heavily on React and Redux.</p>\n<p>It works like this:</p>\n<ul>\n<li>React renders <code>&lt;circle&gt;</code> elements in a loop</li>\n<li>Redux holds an array of <code>[x, y]</code> positions</li>\n<li>Trigger a <code>move particles</code> action 60-times per second</li>\n<li>Add new particles if mousedown</li>\n</ul>\n<p>If you change <code>N</code> particles per loop from 5 to 1,000, all hell breaks loose. Animation grinds to a halt.</p>\n<img class=\"alignnone size-large wp-image-6834\" src=\"http://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-1-1024x551.png\" alt=\"livecoding-12-1\" srcset=\"https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-1-1024x551.png 1024w, https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-1-300x161.png 300w, https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-1-768x413.png 768w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" />\n<p>To get to the bottom of <em>why</em> this happens, we fired up the profiler. There are two suspects:</p>\n<ol>\n<li>Creating new instances of the particles array 60-times per second</li>\n<li>Rendering those DOM nodes</li>\n</ol>\n<p>The profiler wasn’t happy with us:</p>\n<img class=\"alignnone size-large wp-image-6833\" src=\"http://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-2-1024x521.png\" alt=\"livecoding-12-2\" srcset=\"https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-2-1024x521.png 1024w, https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-2-300x153.png 300w, https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-2-768x391.png 768w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" />\n<p>It seems that “scripting” is the culprit, not rendering. In a 21 second experiment, 18 seconds were spent “scripting”, and less than 2 were spent rendering. Curious.</p>\n<p>This implies that copying the array is our big timesink. If this is true, then the fix is simple – use <a href=\"https://facebook.github.io/immutable-js/\">immutable.js</a>. Immutable.js promises to be smart about implementing proper immutable data structures efficiently.</p>\n<p>We turned off rendering and kept the array copying. Things became silky smooth.</p>\n<p>Curiouser and curiouser.</p>\n<p>Looking deeper into the profiler reveals that the problem isn’t data management after all; it’s updating children, either in React or in the DOM.</p>\n<img class=\"alignnone size-large wp-image-6832\" src=\"http://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-3-1024x185.png\" alt=\"livecoding-12-3\" srcset=\"https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-3-1024x185.png 1024w, https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-3-300x54.png 300w, https://swizec.com/blog/wp-content/uploads/2016/06/livecoding-12-3-768x139.png 768w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" />\n<p>Interesting.</p>\n<p>The next thing to try is finding the bottleneck in updating children. Is it React, or is it the DOM? We can figure that out by replacing React rendering with raw d3 rendering.</p>\n<p>This had funny results. Particles didn’t update properly, the animation was glitchy, and there were staleness artifacts galore.</p>\n<p>Looks like React <em>does</em> make our lives easier, despite how great d3 is on its own.</p>\n<img class=\"aligncenter\" src=\"http://i.imgur.com/Thz3F4K.gif\" alt=\"\" width=\"1102\" height=\"577\" />\n<p>But it <em>is</em> faster.</p>\n<p>Then we looked at <a href=\"https://github.com/chenglou/react-motion\">react-motion</a> and <a href=\"https://github.com/reactjs/react-art\">react-art</a>, and we decided that they don’t smell like they can solve our problem. Maybe I just need to invest more time into figuring them out.</p>\n<p>React-motion did give us a great idea though – use css transformations! The GPU renders those; that <em>has got to be fast</em>, right?</p>\n<p>Nope. Not fast.</p>\n<p>Looks like we do have to get away from the DOM completely. The most promising library we could find to do that was <a href=\"https://medium.com/@lavrton/using-react-with-html5-canvas-871d07d8d753#.lrwnvr1z6\">react-koonva</a>.</p>\n<p>I’m sure that <em>next time</em>, we will crack this nut. There <em>will</em> be 10,000 dancing dots on the screen.</p>\n<p>It’s gonna be great.</p>\n<hr />\n<p>&nbsp;</p>\n<p>PS: <span class=\"s1\">the edited and improved versions of these videos are becoming a video course. Readers of the engineer package of <a href=\"http://swizec.com/reactd3js#packages\">React+d3js ES6</a> get it for free when it’s ready.</span></p>\n"},"site":{"siteMetadata":{"title":"Swizec Blog","subtitle":"Fetch Data From Local WP Install"}}},"pageContext":{"id":"d36c30a2-a354-5d02-8e36-78051a1d66b3"}}