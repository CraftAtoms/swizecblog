{"data":{"wordpressPost":{"title":"Always put side effects last","content":"<img src=\"http://d3exkutavo4sli.cloudfront.net/wp-content/uploads/2016/10/salesforce-tower-panorama-1024x358.jpg\" />\n<p>You know how some lessons you can only learn from experience? This is such a lesson. I&#8217;m sharing it with you so that I may remember it better.</p>\n<blockquote class=\"twitter-tweet\" data-width=\"550\" data-dnt=\"true\">\n<p lang=\"en\" dir=\"ltr\">That thing that you can&#39;t learn in a 6 month bootcamp but takes years of trial and error to hone. I don&#39;t know a name for it.</p>\n<p>&mdash; Swizec (@Swizec) <a href=\"https://twitter.com/Swizec/status/950152073819009024?ref_src=twsrc%5Etfw\">January 7, 2018</a></p></blockquote>\n<p><script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script></p>\n<p>Let&#8217;s say you&#8217;re building a system for drip campaigns. Because that&#8217;s how I learned this lesson.</p>\n<p>Your system is given a set of leads. You have to send them a series of messages, update metadata in your database, and keep the sales CRM (customer relationship management) system up-to-date so when a lead eventually replies to your message, a sales person knows what to do.</p>\n<p>Hundreds of these systems have been developed by thousands of developers. You&#8217;re building your own because startups.</p>\n<p>The core of your system is a <code>send_next_message</code> function. Something like this 👇</p>\n<pre><code>def send_next_message(lead)\n    campaign = lead.campaign\n    Twilio.send_message(lead, campaign.message)\n    CRM.update_data(lead)\n    campaign.advance_to_next_message\nend\n</code></pre>\n<p>It makes sense, right? You take the drip campaign, send the current message with Twilio, update some metadata on your CRM, then advance your campaign to the next message.</p>\n<p>Works perfect 👌</p>\n<p>You run it in a cronjob once a day. Like this:</p>\n<pre><code>def send_campaigns\n    Lead.active.each do |lead|\n        send_next_message.perform_async(lead)\n    end\nend\n</code></pre>\n<p>You go through active leads, pick their campaign, and spawn a new background worker with <code>perform_async</code>. Eventually, your queue will run the code and send your campaign.</p>\n<p>If anything goes wrong, each campaign is isolated in its own worker. Errors don&#8217;t affect other campaigns. 👌</p>\n<p>Even better, if something goes wrong while sending the campaign, you can retry the worker.</p>\n<h2>And you&#8217;ve just spammed your leads and made them angry</h2>\n<p>Let&#8217;s review our <code>send_next_message</code> code.</p>\n<pre><code>def send_next_message(lead)\n    campaign = lead.campaign\n    Twilio.send_message(lead, campaign.message)\n    CRM.update_data(lead)\n    campaign.advance_to_next_message\nend\n</code></pre>\n<p>An error can happen at any point here.</p>\n<p>Maybe something goes wrong when you read campaigns from the database. The worker terminates on 1st instruction, and all is good.</p>\n<p>Things can go wrong when talking to Twilio as well. Their service could be down, your internet could act up, or something else entirely. The worker terminates on 2nd instruction, and all is still good.</p>\n<p>What if things break when updating your CRM? Third party service, complex set of instructions with multiple API calls, a lot can go wrong.</p>\n<p>Worker terminates on 3rd instruction.</p>\n<p>Now you&#8217;re in trouble. You&#8217;ve already sent a message to your user, but you weren&#8217;t able to save that info. Your system doesn&#8217;t know sending happened, and your CRM doesn&#8217;t know either.</p>\n<p>When the worker retries, you send the message again.</p>\n<p>And again. And again. Until the whole worker succeeds.</p>\n<p>😅</p>\n<p>Your lead just got a bazillion messages, and they&#8217;re upset.</p>\n<p>Here&#8217;s what you should do instead 👇</p>\n<pre><code>def send_next_message(lead)\n    campaign = lead.campaign\n    message = campaign.message\n    CRM.update_data(lead)\n    campaign.advance_to_next_message\n    Twilio.send_message(lead, campaign.message)\nend\n</code></pre>\n<p>Fetch campaign, save the message in a local variable. <em>Then</em> update data in your CRM. Now if updating the CRM fails, you can keep retrying until it succeeds.</p>\n<p>Updating the CRM was least reliable in my experience.</p>\n<p>After updating the CRM, you update your local database. This is a reliable operation, but the most common source of programmer errors and <code>nil</code> failures. It happens.</p>\n<p>Break fast and move things, right? 🙂</p>\n<p>At the end, when you&#8217;re absolutely certain all your data is updated, you send the message to your lead. This is least likely to fail, and if it does, screw it.</p>\n<p>With this approach, you are guaranteed never to spam your leads. The worst that could happen is that you advance the campaign too early and they get 4 messages instead of 5 and your sales pitch is less polished.</p>\n<p>That&#8217;s okay 🙏🏻 Your copy is robust, and annoying people is bad.</p>\n<p>And now I know why sales automation companies have so much money. This stuff is hard. 😅</p>\n<p><strong>PS:</strong> There are ways to further improve your worker. You could do your DB first, then rollback if an error occurs. You could try to rollback changes on the CRM if sending fails etc. But that gets complicated fast.</p>\n"},"site":{"siteMetadata":{"title":"Swizec Blog","subtitle":"Fetch Data From Local WP Install"}}},"pageContext":{"id":"2d8b1392-8441-51da-bb07-74819086e9d4"}}